digraph BTSN_10_Place_Complex_Buffered {
    rankdir=LR;
    node [fontname="Arial"];
    edge [fontname="Arial"];
    
    // Input Transitions (blue rectangles) - WITH BUFFER SPECIFICATIONS
    node [shape=rect, style=filled, fillcolor=lightblue, width=1.4, height=0.7];
    
    T_in_1 [label="T_in_1\nEntry [buf:30]", buffer=30];
    T_in_2 [label="T_in_2\nAuth Sync [buf:25]", buffer=25];
    T_in_3 [label="T_in_3\nUser Sync [buf:25]", buffer=25];
    T_in_4 [label="T_in_4\nValidation\n3-way sync [buf:150]", buffer=150];
    T_in_5 [label="T_in_5\nProcess\nSync [buf:25]", buffer=25];
    T_in_6 [label="T_in_6\nApproval\nSync [buf:25]", buffer=25];
    T_in_7 [label="T_in_7\nNotify\nSync [buf:25]", buffer=25];
    T_in_8 [label="T_in_8\nAudit\nSync [buf:25]", buffer=25];
    T_in_9 [label="T_in_9\nArchive\nSync [buf:25]", buffer=25];
    T_in_10 [label="T_in_10\nFinal\n3-way sync [buf:150]", buffer=150];
    
    // Places (green circles) - Services with 1:1 relationships
    node [shape=circle, style=filled, fillcolor=lightgreen, width=1.1, height=1.1];
    
    P1 [label="P1\nRequest\nReceiver"];
    P2 [label="P2\nAuth\nService"];
    P3 [label="P3\nUser\nLookup"];
    P4 [label="P4\nBusiness\nValidator"];
    P5 [label="P5\nData\nProcessor"];
    P6 [label="P6\nApproval\nEngine"];
    P7 [label="P7\nNotification\nService"];
    P8 [label="P8\nAudit\nLogger"];
    P9 [label="P9\nArchive\nService"];
    P10 [label="P10\nCompletion\nHandler"];
    
    // Output Transitions (orange rectangles) - Forking only
    node [shape=rect, style=filled, fillcolor=orange, width=1.4, height=0.7];
    
    T_out_1 [label="T_out_1\nFork 3-way"];
    T_out_2 [label="T_out_2\nAuth Result"];
    T_out_3 [label="T_out_3\nUser Result"];
    T_out_4 [label="T_out_4\nFork Parallel"];
    T_out_5 [label="T_out_5\nProcess\nResult"];
    T_out_6 [label="T_out_6\nApproval\nFork"];
    T_out_7 [label="T_out_7\nNotify\nResult"];
    T_out_8 [label="T_out_8\nAudit\nResult"];
    T_out_9 [label="T_out_9\nArchive\nResult"];
    T_out_10 [label="T_out_10\nComplete"];
    
    // External nodes
    node [shape=doublecircle, fillcolor=yellow, width=0.8, height=0.8];
    START [label="START"];
    END [label="END"];
    
    // === IMMUTABLE BUILDING BLOCK FLOWS ===
    // Each place has exactly one T_in and one T_out
    
    // Building block 1
    T_in_1 -> P1;
    P1 -> T_out_1;
    
    // Building block 2 
    T_in_2 -> P2;
    P2 -> T_out_2;
    
    // Building block 3
    T_in_3 -> P3;
    P3 -> T_out_3;
    
    // Building block 4
    T_in_4 -> P4;
    P4 -> T_out_4;
    
    // Building block 5
    T_in_5 -> P5;
    P5 -> T_out_5;
    
    // Building block 6
    T_in_6 -> P6;
    P6 -> T_out_6;
    
    // Building block 7
    T_in_7 -> P7;
    P7 -> T_out_7;
    
    // Building block 8
    T_in_8 -> P8;
    P8 -> T_out_8;
    
    // Building block 9
    T_in_9 -> P9;
    P9 -> T_out_9;
    
    // Building block 10
    T_in_10 -> P10;
    P10 -> T_out_10;
    
    // === COORDINATION FLOWS ===
    
    // Entry point
    START -> T_in_1 [label="request"];
    
    // Initial 3-way fork
    T_out_1 -> T_in_2 [label="auth\nrequest", color=red, style=bold];
    T_out_1 -> T_in_3 [label="user\nlookup", color=red, style=bold];
    T_out_1 -> T_in_4 [label="validation\nrequest", color=green, style="bold,dashed"]; // Feedforward bypass
    
    // 3-way synchronization at validation
    T_out_2 -> T_in_4 [label="auth\nresult", color=blue, style=bold];
    T_out_3 -> T_in_4 [label="user\ndata", color=blue, style=bold];
    // T_out_1 already connected above as feedforward
    
    // Validation forks to parallel processing
    T_out_4 -> T_in_5 [label="to\nprocessing", color=red, style=bold];
    T_out_4 -> T_in_6 [label="to\napproval", color=red, style=bold];
    
    // Processing result continues
    T_out_5 -> T_in_7 [label="notify\nrequest", color=blue];
    
    // Approval forks to audit and archive
    T_out_6 -> T_in_8 [label="audit\nrequest", color=red, style=bold];
    T_out_6 -> T_in_9 [label="archive\nrequest", color=red, style=bold];
    
    // Final 3-way synchronization
    T_out_7 -> T_in_10 [label="notify\ndone", color=blue, style=bold];
    T_out_8 -> T_in_10 [label="audit\ndone", color=blue, style=bold];
    T_out_9 -> T_in_10 [label="archive\ndone", color=blue, style=bold];
    
    // Completion
    T_out_10 -> END [label="finished"];
    
    // Layout hints for better organization
    {rank=same; T_in_2; T_in_3; T_in_4}
    {rank=same; P2; P3; P4}
    {rank=same; T_out_2; T_out_3; T_out_4}
    
    {rank=same; T_in_5; T_in_6}
    {rank=same; P5; P6}
    {rank=same; T_out_5; T_out_6}
    
    {rank=same; T_in_8; T_in_9}
    {rank=same; P8; P9}
    {rank=same; T_out_8; T_out_9}
    
    // Buffer Sizing Strategy Description
    label="BTSN 10-Place Complex Workflow with Strategic Buffer Sizing\n\n" +
          "Buffer Sizing Strategy:\n" +
          "• Entry Point (T_in_1): 30 tokens - slightly higher for system entry\n" +
          "• Simple Sync (=1 source): 25 tokens - standard capacity\n" +
          "• Complex Sync (3+ sources): 150 tokens - large capacity for coordination\n\n" +
          "Critical Synchronization Points:\n" +
          "• T_in_4: 3-way sync [buf:150] - auth + user + feedforward validation\n" +
          "• T_in_10: 3-way sync [buf:150] - notify + audit + archive completion\n\n" +
          "Architecture Pattern Testing:\n" +
          "• Initial 3-way fork (T_out_1 ? T_in_2,3,4)\n" +
          "• Feedforward bypass (green dashed: fast validation path)\n" +
          "• Complex synchronization with different arrival times\n" +
          "• Parallel processing branches (T_out_4 ? T_in_5,6)\n" +
          "• Multiple fork points and final convergence\n" +
          "• End-to-end workflow with 10 service stages\n\n" +
          "Expected Behavior:\n" +
          "• High buffer utilization at T_in_4 and T_in_10\n" +
          "• Moderate utilization at entry point T_in_1\n" +
          "• Low utilization at simple synchronization points\n" +
          "• Complex correlation tracking through multiple forks/joins";
    
    fontsize=8;
}