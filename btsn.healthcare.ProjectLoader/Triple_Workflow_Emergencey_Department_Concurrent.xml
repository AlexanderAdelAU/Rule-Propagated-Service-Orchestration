<?xml version="1.0" encoding="UTF-8"?>
<project name="Emergency_Department_Federated_Radiology" default="run-complete-workflow" basedir="."
	    xmlns:if="ant:if" xmlns:unless="ant:unless">
	<description>
		Emergency Department with Federated Radiology - Multi-Workflow Execution
		
		This build file demonstrates concurrent execution of THREE separate workflows:
		- workflow1: Emergency_Department_Patient_Workflow (v003) - PATIENT_ARRIVAL -> Full ED flow
		- workflow2: Triage_Workflow (v002) - CANARY_TEST -> Triage only
		- workflow3: Federated_Radiology_Workflow (v001) - FEDERATED_RADIOLOGY_REQUEST -> Radiology direct
		
		Architecture:
		- Phase 1: Load services ONCE, Initialize databases
		- Phase 2: Deploy ALL THREE workflows sequentially -> Fire tokens from ALL generators in PARALLEL
		- Phase 3: Deploy collector rules -> Collect data
		
		Each workflow has its own process definition JSON file and version for token isolation.
	</description>

	<!-- ======================================================================= -->
	<!-- DEPLOYMENT CONFIGURATION                                                -->
	<!-- ======================================================================= -->
	<!-- Service deployment modes:                                                -->
	<!--   local  = launch service process on THIS machine                       -->
	<!--   remote = service runs on ANOTHER machine (skip launch, still send     -->
	<!--            events to it for init/workflow/collection phases)             -->
	<!--                                                                         -->
	<!-- Override from command line: ant -Dtriage.mode=remote                     -->
	<!-- ======================================================================= -->

	<property name="triage.mode"     value="remote" />
	<property name="laboratory.mode" value="local" />
	<property name="radiology.mode"  value="local" />
	<property name="cardiology.mode" value="local" />
	<property name="diagnosis.mode"  value="local" />
	<property name="treatment.mode"  value="local" />
	<property name="monitor.mode"    value="local" />

	<!-- ======================================================================= -->
	<!-- PROPERTIES                                                              -->
	<!-- ======================================================================= -->

	<!-- Process names for each phase -->
	<property name="init.process.name" value="healthcare/Initializers/Multi_Service_Initialization" />
	<property name="workflow1.process.name" value="healthcare/Workflow/Emergency_Department_Patient_Workflow" />
	<property name="workflow2.process.name" value="healthcare/Workflow/Triage_CanaryTest_Workflow" />
	<property name="workflow3.process.name" value="healthcare/Workflow/Federated_Radiology_Workflow" />
	<property name="collector.process.name" value="healthcare/Collectors/Multi_Service_Collector" />

	<!-- Phase 1: Initialization parameters -->
	<property name="db.init.operation" value="purgeAndInitialize" />
	<property name="sequence.id.init.triage" value="100000" />
	<property name="sequence.id.init.laboratory" value="110000" />
	<property name="sequence.id.init.radiology" value="120000" />
	<property name="sequence.id.init.cardiology" value="130000" />
	<property name="sequence.id.init.diagnosis" value="140000" />
	<property name="sequence.id.init.treatment" value="150000" />
	<property name="sequence.id.init.monitor" value="160000" />

	<!-- ======================================================================= -->
	<!-- PATIENT_ARRIVAL Event Generator (v003) - Tokens enter via Triage       -->
	<!-- ======================================================================= -->
	<property name="patient.version" value="v003" />
	<property name="patient.generator.id" value="PATIENT_ARRIVAL" />
	<property name="patient.target.service" value="TriageService" />
	<property name="patient.target.operation" value="processTriageAssessment" />
	<property name="patient.token.count" value="20" />
	<property name="patient.token.expire" value="120000" />

	<!-- ======================================================================= -->
	<!-- CANARY_TEST Event Generator (v002) - Test tokens via Triage             -->
	<!-- ======================================================================= -->
	<property name="canary.version" value="v002" />
	<property name="canary.generator.id" value="CANARY_TEST" />
	<property name="canary.target.service" value="TriageService" />
	<property name="canary.target.operation" value="processTriageAssessment" />
	<property name="canary.token.count" value="10" />
	<property name="canary.token.expire" value="120000" />

	<!-- ======================================================================= -->
	<!-- FEDERATED_RADIOLOGY_REQUEST Event Generator (v001) - Direct to Radiology -->
	<!-- ======================================================================= -->
	<property name="federated.version" value="v001" />
	<property name="federated.generator.id" value="FEDERATED_RADIOLOGY_REQUEST" />
	<property name="federated.target.service" value="RadiologyService" />
	<property name="federated.target.operation" value="federatedRadiologyRequest" />
	<property name="federated.token.count" value="10" />
	<property name="federated.token.expire" value="120000" />

	<!-- Phase 3: Collector parameters -->
	<property name="collector.operation" value="collectAllData" />
	<property name="collector.deploy.version" value="v001" />
	<property name="collector.query.versions" value="v001,v002,v003" />
	<property name="sequence.id.collect.triage" value="1410000" />
	<property name="sequence.id.collect.laboratory" value="1420000" />
	<property name="sequence.id.collect.radiology" value="1430000" />
	<property name="sequence.id.collect.cardiology" value="1440000" />
	<property name="sequence.id.collect.diagnosis" value="1450000" />
	<property name="sequence.id.collect.treatment" value="1460000" />
	<property name="collector.delay.seconds" value="3" />

	<!-- Timing parameters -->
	<property name="service.startup.seconds" value="5" />
	<property name="phase.delay.seconds" value="5" />
	<property name="deploy.wait.seconds" value="3" />

	<!-- Base directories -->
	<property name="build.file.dir" location="." />
	<property name="healthcare.root.dir" location="../" />

	<!-- Common project -->
	<property name="common.project.dir" location="${healthcare.root.dir}/btsn.common" />
	<property name="lib.dir" location="${common.project.dir}/lib" />
	<property name="class.dir" location="${common.project.dir}/bin" />
	<property name="common.src.dir" location="${common.project.dir}/src" />

	<!-- Output directory -->
	<property name="output.dir" location="${build.file.dir}" />
	<property name="triage.output.file" location="${output.dir}/TriageService_out.txt" />
	<property name="laboratory.output.file" location="${output.dir}/LaboratoryService_out.txt" />
	<property name="radiology.output.file" location="${output.dir}/RadiologyService_out.txt" />
	<property name="cardiology.output.file" location="${output.dir}/CardiologyService_out.txt" />
	<property name="diagnosis.output.file" location="${output.dir}/DiagnosisService_out.txt" />
	<property name="treatment.output.file" location="${output.dir}/TreatmentService_out.txt" />
	<property name="monitor.output.file" location="${output.dir}/MonitorService_out.txt" />

	<!-- Service Projects -->
	<property name="triage.project.dir" location="${healthcare.root.dir}/btsn.healthcare.places.Triage" />
	<property name="triage.bin.dir" location="${triage.project.dir}/bin" />

	<property name="laboratory.project.dir" location="${healthcare.root.dir}/btsn.healthcare.places.Laboratory" />
	<property name="laboratory.bin.dir" location="${laboratory.project.dir}/bin" />

	<property name="radiology.project.dir" location="${healthcare.root.dir}/btsn.healthcare.places.Radiology" />
	<property name="radiology.bin.dir" location="${radiology.project.dir}/bin" />

	<property name="cardiology.project.dir" location="${healthcare.root.dir}/btsn.healthcare.places.Cardiology" />
	<property name="cardiology.bin.dir" location="${cardiology.project.dir}/bin" />

	<property name="diagnosis.project.dir" location="${healthcare.root.dir}/btsn.healthcare.places.Diagnosis" />
	<property name="diagnosis.bin.dir" location="${diagnosis.project.dir}/bin" />

	<property name="treatment.project.dir" location="${healthcare.root.dir}/btsn.healthcare.places.Treatment" />
	<property name="treatment.bin.dir" location="${treatment.project.dir}/bin" />

	<property name="monitor.project.dir" location="${healthcare.root.dir}/btsn.common.Monitor" />
	<property name="monitor.bin.dir" location="${monitor.project.dir}/bin" />

	<!-- Event Generators -->
	<property name="generator.project.dir" location="${healthcare.root.dir}/btsn.common.eventgenerators" />
	<property name="generator.bin.dir" location="${generator.project.dir}/bin" />
	<property name="generator.src.dir" location="${generator.project.dir}/src" />

	<!-- Java Classes -->
	<property name="service.loader.class" value="org.btsn.handlers.ServiceLoader" />
	<property name="init.event.generator.class" value="org.btsn.common.eventgenerators.DatabaseInitialization_EventGenerator" />
	<property name="token.generator.class" value="org.btsn.healthcare.eventgenerators.GenericHealthcareTokenGenerator" />
	<property name="collector.event.generator.class" value="org.btsn.common.eventgenerators.Common_Collector_EventGenerator" />

	<!-- ======================================================================= -->
	<!-- CLASSPATHS                                                              -->
	<!-- ======================================================================= -->

	<path id="common.classpath">
		<fileset dir="${lib.dir}" erroronmissingdir="false">
			<include name="*.jar" />
		</fileset>
		<pathelement location="${class.dir}" />
	</path>

	<path id="triage.classpath">
		<path refid="common.classpath" />
		<pathelement location="${triage.bin.dir}" />
	</path>

	<path id="laboratory.classpath">
		<path refid="common.classpath" />
		<pathelement location="${laboratory.bin.dir}" />
	</path>

	<path id="radiology.classpath">
		<path refid="common.classpath" />
		<pathelement location="${radiology.bin.dir}" />
	</path>

	<path id="cardiology.classpath">
		<path refid="common.classpath" />
		<pathelement location="${cardiology.bin.dir}" />
	</path>

	<path id="diagnosis.classpath">
		<path refid="common.classpath" />
		<pathelement location="${diagnosis.bin.dir}" />
	</path>

	<path id="treatment.classpath">
		<path refid="common.classpath" />
		<pathelement location="${treatment.bin.dir}" />
	</path>

	<path id="monitor.classpath">
		<path refid="common.classpath" />
		<pathelement location="${monitor.bin.dir}" />
	</path>

	<path id="generator.classpath">
		<path refid="common.classpath" />
		<pathelement location="${generator.bin.dir}" />
	</path>

	<!-- ======================================================================= -->
	<!-- DEPLOYMENT MODE RESOLUTION                                              -->
	<!-- ======================================================================= -->

	<target name="resolve-deployment-modes">
		<!-- Resolve boolean properties from mode settings -->
		<condition property="triage.is.local"><equals arg1="${triage.mode}" arg2="local" /></condition>
		<condition property="laboratory.is.local"><equals arg1="${laboratory.mode}" arg2="local" /></condition>
		<condition property="radiology.is.local"><equals arg1="${radiology.mode}" arg2="local" /></condition>
		<condition property="cardiology.is.local"><equals arg1="${cardiology.mode}" arg2="local" /></condition>
		<condition property="diagnosis.is.local"><equals arg1="${diagnosis.mode}" arg2="local" /></condition>
		<condition property="treatment.is.local"><equals arg1="${treatment.mode}" arg2="local" /></condition>
		<condition property="monitor.is.local"><equals arg1="${monitor.mode}" arg2="local" /></condition>

		<!-- Display deployment configuration -->
		<echo message="" />
		<echo message="  Deployment Configuration:" />
		<echo message="    Triage:     ${triage.mode}" />
		<echo message="    Laboratory: ${laboratory.mode}" />
		<echo message="    Radiology:  ${radiology.mode}" />
		<echo message="    Cardiology: ${cardiology.mode}" />
		<echo message="    Diagnosis:  ${diagnosis.mode}" />
		<echo message="    Treatment:  ${treatment.mode}" />
		<echo message="    Monitor:    ${monitor.mode}" />
		<echo message="" />
	</target>

	<!-- ======================================================================= -->
	<!-- UTILITY TARGETS                                                         -->
	<!-- ======================================================================= -->

	<target name="kill-java" description="Kill all running Java processes - RUN SEPARATELY before ant (will kill Ant too!)">
		<echo message="WARNING: This will kill ALL Java processes including Ant!" />
		<echo message="Run this BEFORE starting ant, not as a dependency." />
		<echo message="Killing any existing Java processes..." />
		<exec executable="taskkill" failonerror="false" osfamily="windows">
			<arg value="/F" />
			<arg value="/IM" />
			<arg value="java.exe" />
		</exec>
		<exec executable="taskkill" failonerror="false" osfamily="windows">
			<arg value="/F" />
			<arg value="/IM" />
			<arg value="javaw.exe" />
		</exec>
		<!-- Unix/Linux/Mac equivalent -->
		<exec executable="pkill" failonerror="false" osfamily="unix">
			<arg value="-9" />
			<arg value="java" />
		</exec>
		<echo message="Java processes killed." />
	</target>

	<target name="create-output-directory">
		<mkdir dir="${output.dir}" />
	</target>

	<target name="clean-output" description="Clean previous output files">
		<delete file="${triage.output.file}" quiet="true" />
		<delete file="${laboratory.output.file}" quiet="true" />
		<delete file="${radiology.output.file}" quiet="true" />
		<delete file="${cardiology.output.file}" quiet="true" />
		<delete file="${diagnosis.output.file}" quiet="true" />
		<delete file="${treatment.output.file}" quiet="true" />
		<delete file="${monitor.output.file}" quiet="true" />
		<echo message="Previous output files cleaned" />
	</target>

	<!-- ======================================================================= -->
	<!-- MAIN WORKFLOW TARGET                                                    -->
	<!-- ======================================================================= -->

	<target name="run-complete-workflow" depends="resolve-deployment-modes,create-output-directory,clean-output"
	        description="Run complete Emergency Department workflow with federated Radiology">

		<echo message="================================================================" />
		<echo message="  EMERGENCY DEPARTMENT - MULTI-WORKFLOW EXECUTION              " />
		<echo message="================================================================" />
		<echo message="" />
		<echo message="  Workflows:" />
		<echo message="    1. ${workflow1.process.name} (${patient.version}): ${patient.token.count} tokens" />
		<echo message="    2. ${workflow2.process.name} (${canary.version}): ${canary.token.count} tokens" />
		<echo message="    3. ${workflow3.process.name} (${federated.version}): ${federated.token.count} tokens" />
		<echo message="" />
		<echo message="  Token Isolation via versions: v001, v002, v003" />
		<echo message="================================================================" />

		<parallel>
			<!-- ============================================================= -->
			<!-- PARALLEL: Start all 7 services (ONCE)                         -->
			<!-- ============================================================= -->

			<!-- Triage Service -->
			<echo message="  [triage] Skipping - running on remote host" unless:set="triage.is.local" />
			<java classname="${service.loader.class}" fork="true" if:set="triage.is.local"
			      dir="${triage.project.dir}" output="${triage.output.file}">
				<classpath refid="triage.classpath" />
				<arg value="${triage.project.dir}" />
				<arg value="-version" /><arg value="${patient.version}" />
			</java>

			<!-- Laboratory Service -->
			<echo message="  [laboratory] Skipping - running on remote host" unless:set="laboratory.is.local" />
			<java classname="${service.loader.class}" fork="true" if:set="laboratory.is.local"
			      dir="${laboratory.project.dir}" output="${laboratory.output.file}">
				<classpath refid="laboratory.classpath" />
				<arg value="${laboratory.project.dir}" />
				<arg value="-version" /><arg value="${patient.version}" />
			</java>

			<!-- Radiology Service -->
			<echo message="  [radiology] Skipping - running on remote host" unless:set="radiology.is.local" />
			<java classname="${service.loader.class}" fork="true" if:set="radiology.is.local"
			      dir="${radiology.project.dir}" output="${radiology.output.file}">
				<classpath refid="radiology.classpath" />
				<arg value="${radiology.project.dir}" />
				<arg value="-version" /><arg value="${patient.version}" />
			</java>

			<!-- Cardiology Service -->
			<echo message="  [cardiology] Skipping - running on remote host" unless:set="cardiology.is.local" />
			<java classname="${service.loader.class}" fork="true" if:set="cardiology.is.local"
			      dir="${cardiology.project.dir}" output="${cardiology.output.file}">
				<classpath refid="cardiology.classpath" />
				<arg value="${cardiology.project.dir}" />
				<arg value="-version" /><arg value="${patient.version}" />
			</java>

			<!-- Diagnosis Service -->
			<echo message="  [diagnosis] Skipping - running on remote host" unless:set="diagnosis.is.local" />
			<java classname="${service.loader.class}" fork="true" if:set="diagnosis.is.local"
			      dir="${diagnosis.project.dir}" output="${diagnosis.output.file}">
				<classpath refid="diagnosis.classpath" />
				<arg value="${diagnosis.project.dir}" />
				<arg value="-version" /><arg value="${patient.version}" />
			</java>

			<!-- Treatment Service -->
			<echo message="  [treatment] Skipping - running on remote host" unless:set="treatment.is.local" />
			<java classname="${service.loader.class}" fork="true" if:set="treatment.is.local"
			      dir="${treatment.project.dir}" output="${treatment.output.file}">
				<classpath refid="treatment.classpath" />
				<arg value="${treatment.project.dir}" />
				<arg value="-version" /><arg value="${patient.version}" />
			</java>

			<!-- Monitor Service -->
			<echo message="  [monitor] Skipping - running on remote host" unless:set="monitor.is.local" />
			<java classname="${service.loader.class}" fork="true" if:set="monitor.is.local"
			      dir="${monitor.project.dir}" output="${monitor.output.file}">
				<classpath refid="monitor.classpath" />
				<arg value="${monitor.project.dir}" />
				<arg value="-version" /><arg value="${patient.version}" />
			</java>

			<!-- ============================================================= -->
			<!-- SEQUENTIAL: Execute phases in order                           -->
			<!-- ============================================================= -->
			<sequential>
				<echo message="Waiting ${service.startup.seconds}s for services to start..." />
				<sleep seconds="${service.startup.seconds}" />

				<!-- ======================================================= -->
				<!-- PHASE 1: Database Initialization                        -->
				<!-- ======================================================= -->
				<echo message="" />
				<echo message="===============================================" />
				<echo message="    PHASE 1: DATABASE INITIALIZATION           " />
				<echo message="===============================================" />
				
				<!-- Deploy Initialization rules -->
				<echo message="Deploying Initialization rules..." />
				<java classname="${init.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="Triage_InitializationService" />
					<arg value="-operation" /><arg value="${db.init.operation}" />
					<arg value="-version" /><arg value="${patient.version}" />
					<arg value="-process" /><arg value="${init.process.name}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.init.triage}" />
					<arg value="-tokens" /><arg value="0" />
				</java>

				<!-- Fire initialization tokens in PARALLEL -->
				<echo message="Firing initialization tokens in PARALLEL..." />
				<parallel>
					<java classname="${init.event.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-service" /><arg value="Triage_InitializationService" />
						<arg value="-operation" /><arg value="${db.init.operation}" />
						<arg value="-version" /><arg value="${patient.version}" />
						<arg value="-process" /><arg value="${init.process.name}" />
						<arg value="-sequenceId" /><arg value="${sequence.id.init.triage}" />
						<arg value="-tokens" /><arg value="1" />
						<arg value="-skipDeploy" />
					</java>
					<java classname="${init.event.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-service" /><arg value="Laboratory_InitializationService" />
						<arg value="-operation" /><arg value="${db.init.operation}" />
						<arg value="-version" /><arg value="${patient.version}" />
						<arg value="-process" /><arg value="${init.process.name}" />
						<arg value="-sequenceId" /><arg value="${sequence.id.init.laboratory}" />
						<arg value="-tokens" /><arg value="1" />
						<arg value="-skipDeploy" />
					</java>
					<java classname="${init.event.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-service" /><arg value="Radiology_InitializationService" />
						<arg value="-operation" /><arg value="${db.init.operation}" />
						<arg value="-version" /><arg value="${patient.version}" />
						<arg value="-process" /><arg value="${init.process.name}" />
						<arg value="-sequenceId" /><arg value="${sequence.id.init.radiology}" />
						<arg value="-tokens" /><arg value="1" />
						<arg value="-skipDeploy" />
					</java>
					<java classname="${init.event.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-service" /><arg value="Cardiology_InitializationService" />
						<arg value="-operation" /><arg value="${db.init.operation}" />
						<arg value="-version" /><arg value="${patient.version}" />
						<arg value="-process" /><arg value="${init.process.name}" />
						<arg value="-sequenceId" /><arg value="${sequence.id.init.cardiology}" />
						<arg value="-tokens" /><arg value="1" />
						<arg value="-skipDeploy" />
					</java>
					<java classname="${init.event.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-service" /><arg value="Diagnosis_InitializationService" />
						<arg value="-operation" /><arg value="${db.init.operation}" />
						<arg value="-version" /><arg value="${patient.version}" />
						<arg value="-process" /><arg value="${init.process.name}" />
						<arg value="-sequenceId" /><arg value="${sequence.id.init.diagnosis}" />
						<arg value="-tokens" /><arg value="1" />
						<arg value="-skipDeploy" />
					</java>
					<java classname="${init.event.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-service" /><arg value="Treatment_InitializationService" />
						<arg value="-operation" /><arg value="${db.init.operation}" />
						<arg value="-version" /><arg value="${patient.version}" />
						<arg value="-process" /><arg value="${init.process.name}" />
						<arg value="-sequenceId" /><arg value="${sequence.id.init.treatment}" />
						<arg value="-tokens" /><arg value="1" />
						<arg value="-skipDeploy" />
					</java>
					<java classname="${init.event.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-service" /><arg value="Monitor_InitializationService" />
						<arg value="-operation" /><arg value="${db.init.operation}" />
						<arg value="-version" /><arg value="${patient.version}" />
						<arg value="-process" /><arg value="${init.process.name}" />
						<arg value="-sequenceId" /><arg value="${sequence.id.init.monitor}" />
						<arg value="-tokens" /><arg value="1" />
						<arg value="-skipDeploy" />
					</java>
				</parallel>

				<echo message="=== Phase 1 Complete ===" />
				<sleep seconds="${phase.delay.seconds}" />

				<!-- ======================================================= -->
				<!-- PHASE 2: Federated Workflow Execution                   -->
				<!-- Deploy ALL THREE workflows -> Fire from ALL generators in PARALLEL -->
				<!-- ======================================================= -->
				<echo message="" />
				<echo message="===============================================" />
				<echo message="    PHASE 2: FEDERATED WORKFLOW EXECUTION      " />
				<echo message="===============================================" />
				<echo message="" />
				<echo message="Workflows:" />
				<echo message="  ${workflow1.process.name} (${patient.version}): PATIENT_ARRIVAL -> Triage -> Full ED flow" />
				<echo message="  ${workflow2.process.name} (${canary.version}): CANARY_TEST -> Triage only" />
				<echo message="  ${workflow3.process.name} (${federated.version}): FEDERATED_RADIOLOGY_REQUEST -> Radiology direct" />
				<echo message="" />

				<!-- Deploy Workflow 1: Emergency_Department_Patient_Workflow (v003) -->
				<echo message="[DEPLOY 1/3] Deploying ${workflow1.process.name} for ${patient.version} (PATIENT_ARRIVAL)..." />
				<java classname="${token.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-version" /><arg value="${patient.version}" />
					<arg value="-process" /><arg value="${workflow1.process.name}" />
					<arg value="-service" /><arg value="${patient.target.service}" />
					<arg value="-operation" /><arg value="${patient.target.operation}" />
					<arg value="-tokens" /><arg value="0" />
					<arg value="-expire" /><arg value="${patient.token.expire}" />
					<arg value="-generator" /><arg value="${patient.generator.id}" />
				</java>

				<!-- Deploy Workflow 2: Triage_Workflow (v002) -->
				<echo message="[DEPLOY 2/3] Deploying ${workflow2.process.name} for ${canary.version} (CANARY_TEST)..." />
				<java classname="${token.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-version" /><arg value="${canary.version}" />
					<arg value="-process" /><arg value="${workflow2.process.name}" />
					<arg value="-service" /><arg value="${canary.target.service}" />
					<arg value="-operation" /><arg value="${canary.target.operation}" />
					<arg value="-tokens" /><arg value="0" />
					<arg value="-expire" /><arg value="${canary.token.expire}" />
					<arg value="-generator" /><arg value="${canary.generator.id}" />
				</java>

				<!-- Deploy Workflow 3: Federated_Radiology_Workflow (v001) -->
				<echo message="[DEPLOY 3/3] Deploying ${workflow3.process.name} for ${federated.version} (FEDERATED_RADIOLOGY_REQUEST)..." />
				<java classname="${token.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-version" /><arg value="${federated.version}" />
					<arg value="-process" /><arg value="${workflow3.process.name}" />
					<arg value="-service" /><arg value="${federated.target.service}" />
					<arg value="-operation" /><arg value="${federated.target.operation}" />
					<arg value="-tokens" /><arg value="0" />
					<arg value="-expire" /><arg value="${federated.token.expire}" />
					<arg value="-generator" /><arg value="${federated.generator.id}" />
				</java>

				<echo message="Waiting ${deploy.wait.seconds}s for commitment..." />
				<sleep seconds="${deploy.wait.seconds}" />

				<!-- Fire tokens from ALL THREE generators in PARALLEL -->
				<echo message="" />
				<echo message="[FIRE] Firing tokens from all three generators in PARALLEL..." />
				<parallel>
					<!-- PATIENT_ARRIVAL: Full ED workflow via Triage -->
					<java classname="${token.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-version" /><arg value="${patient.version}" />
						<arg value="-process" /><arg value="${workflow1.process.name}" />
						<arg value="-service" /><arg value="${patient.target.service}" />
						<arg value="-operation" /><arg value="${patient.target.operation}" />
						<arg value="-tokens" /><arg value="${patient.token.count}" />
						<arg value="-expire" /><arg value="${patient.token.expire}" />
						<arg value="-generator" /><arg value="${patient.generator.id}" />
						<arg value="-skipDeploy" />
					</java>

					<!-- CANARY_TEST: Triage-only workflow -->
					<java classname="${token.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-version" /><arg value="${canary.version}" />
						<arg value="-process" /><arg value="${workflow2.process.name}" />
						<arg value="-service" /><arg value="${canary.target.service}" />
						<arg value="-operation" /><arg value="${canary.target.operation}" />
						<arg value="-tokens" /><arg value="${canary.token.count}" />
						<arg value="-expire" /><arg value="${canary.token.expire}" />
						<arg value="-generator" /><arg value="${canary.generator.id}" />
						<arg value="-skipDeploy" />
					</java>
					

					<!-- FEDERATED_RADIOLOGY_REQUEST: Direct to Radiology workflow -->
					<java classname="${token.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-version" /><arg value="${federated.version}" />
						<arg value="-process" /><arg value="${workflow3.process.name}" />
						<arg value="-service" /><arg value="${federated.target.service}" />
						<arg value="-operation" /><arg value="${federated.target.operation}" />
						<arg value="-tokens" /><arg value="${federated.token.count}" />
						<arg value="-expire" /><arg value="${federated.token.expire}" />
						<arg value="-generator" /><arg value="${federated.generator.id}" />
						<arg value="-skipDeploy" />
					</java>
				</parallel>

				<echo message="=== Phase 2 Complete ===" />
				<sleep seconds="${phase.delay.seconds}" />

				<!-- ======================================================= -->
				<!-- PHASE 3: Data Collection                                -->
				<!-- ======================================================= -->
				<echo message="" />
				<echo message="===============================================" />
				<echo message="    PHASE 3: DATA COLLECTION                   " />
				<echo message="===============================================" />

				<!-- Deploy Collector rules (first collector) -->
				<echo message="Deploying Collector rules..." />
				<java classname="${collector.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="Triage_CollectorService" />
					<arg value="-operation" /><arg value="${collector.operation}" />
					<arg value="-version" /><arg value="${collector.deploy.version}" />
					<arg value="-process" /><arg value="${collector.process.name}" />
					<arg value="-queryVersion" /><arg value="${collector.query.versions}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.collect.triage}" />
				</java>
				<sleep seconds="${collector.delay.seconds}" />

				<!-- Fire collectors sequentially with -skipDeploy -->
				<echo message="Collecting data from all services..." />

				<!-- Laboratory Collector -->
				<java classname="${collector.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="Laboratory_CollectorService" />
					<arg value="-operation" /><arg value="${collector.operation}" />
					<arg value="-version" /><arg value="${collector.deploy.version}" />
					<arg value="-process" /><arg value="${collector.process.name}" />
					<arg value="-queryVersion" /><arg value="${collector.query.versions}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.collect.laboratory}" />
					<arg value="-skipDeploy" />
				</java>
				<sleep seconds="${collector.delay.seconds}" />

				<!-- Radiology Collector -->
				<java classname="${collector.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="Radiology_CollectorService" />
					<arg value="-operation" /><arg value="${collector.operation}" />
					<arg value="-version" /><arg value="${collector.deploy.version}" />
					<arg value="-process" /><arg value="${collector.process.name}" />
					<arg value="-queryVersion" /><arg value="${collector.query.versions}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.collect.radiology}" />
					<arg value="-skipDeploy" />
				</java>
				<sleep seconds="${collector.delay.seconds}" />

				<!-- Cardiology Collector -->
				<java classname="${collector.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="Cardiology_CollectorService" />
					<arg value="-operation" /><arg value="${collector.operation}" />
					<arg value="-version" /><arg value="${collector.deploy.version}" />
					<arg value="-process" /><arg value="${collector.process.name}" />
					<arg value="-queryVersion" /><arg value="${collector.query.versions}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.collect.cardiology}" />
					<arg value="-skipDeploy" />
				</java>
				<sleep seconds="${collector.delay.seconds}" />

				<!-- Diagnosis Collector -->
				<java classname="${collector.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="Diagnosis_CollectorService" />
					<arg value="-operation" /><arg value="${collector.operation}" />
					<arg value="-version" /><arg value="${collector.deploy.version}" />
					<arg value="-process" /><arg value="${collector.process.name}" />
					<arg value="-queryVersion" /><arg value="${collector.query.versions}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.collect.diagnosis}" />
					<arg value="-skipDeploy" />
				</java>
				<sleep seconds="${collector.delay.seconds}" />

				<!-- Treatment Collector -->
				<java classname="${collector.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="Treatment_CollectorService" />
					<arg value="-operation" /><arg value="${collector.operation}" />
					<arg value="-version" /><arg value="${collector.deploy.version}" />
					<arg value="-process" /><arg value="${collector.process.name}" />
					<arg value="-queryVersion" /><arg value="${collector.query.versions}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.collect.treatment}" />
					<arg value="-skipDeploy" />
				</java>

				<echo message="=== Phase 3 Complete ===" />

				<echo message="" />
				<echo message="================================================================" />
				<echo message="  MULTI-WORKFLOW EXECUTION COMPLETED SUCCESSFULLY              " />
				<echo message="================================================================" />
				<echo message="" />
				<echo message="Workflows Executed:" />
				<echo message="  1. ${workflow1.process.name} (${patient.version}): ${patient.token.count} tokens" />
				<echo message="  2. ${workflow2.process.name} (${canary.version}): ${canary.token.count} tokens" />
				<echo message="  3. ${workflow3.process.name} (${federated.version}): ${federated.token.count} tokens" />
				<echo message="" />
				<echo message="Output files:" />
				<echo message="  Triage:     ${triage.output.file}" />
				<echo message="  Laboratory: ${laboratory.output.file}" />
				<echo message="  Radiology:  ${radiology.output.file}" />
				<echo message="  Cardiology: ${cardiology.output.file}" />
				<echo message="  Diagnosis:  ${diagnosis.output.file}" />
				<echo message="  Treatment:  ${treatment.output.file}" />
				<echo message="  Monitor:    ${monitor.output.file}" />
				<echo message="" />
				<echo message="Services are still running. Press Ctrl+C to stop." />
			</sequential>
		</parallel>
	</target>

	<!-- ======================================================================= -->
	<!-- HELP TARGET                                                             -->
	<!-- ======================================================================= -->

	<target name="help" description="Display usage information">
		<echo message="" />
		<echo message="================================================================" />
		<echo message="  EMERGENCY DEPARTMENT - MULTI-WORKFLOW EXECUTION              " />
		<echo message="================================================================" />
		<echo message="" />
		<echo message="THREE CONCURRENT WORKFLOWS:" />
		<echo message="" />
		<echo message="  Workflow 1: ${workflow1.process.name} (${patient.version})" />
		<echo message="    PATIENT_ARRIVAL -> Triage -> [Lab, Cardio, Radiology] -> Diagnosis -> Treatment -> Monitor" />
		<echo message="" />
		<echo message="  Workflow 2: ${workflow2.process.name} (${canary.version})" />
		<echo message="    CANARY_TEST -> Triage -> Monitor (test/canary tokens)" />
		<echo message="" />
		<echo message="  Workflow 3: ${workflow3.process.name} (${federated.version})" />
		<echo message="    FEDERATED_RADIOLOGY_REQUEST -> Radiology -> Monitor (bypasses Triage)" />
		<echo message="" />
		<echo message="EXECUTION PATTERN:" />
		<echo message="  Phase 1: Load services ONCE, Initialize databases (parallel)" />
		<echo message="  Phase 2: Deploy ALL THREE workflows sequentially -> Fire ALL generators in PARALLEL" />
		<echo message="  Phase 3: Collect data from all services" />
		<echo message="" />
		<echo message="USAGE:" />
		<echo message="  ant                              Run complete workflow (default)" />
		<echo message="  ant run-complete-workflow        Run complete workflow" />
		<echo message="  ant help                         Show this help" />
		<echo message="" />
		<echo message="CONFIGURABLE PARAMETERS:" />
		<echo message="  -Dpatient.token.count=30         Tokens via PATIENT_ARRIVAL (workflow1)" />
		<echo message="  -Dcanary.token.count=10           Tokens via CANARY_TEST (workflow2)" />
		<echo message="  -Dfederated.token.count=10        Tokens via FEDERATED_RADIOLOGY_REQUEST (workflow3)" />
		<echo message="  -Dservice.startup.seconds=5      Wait for services to start" />
		<echo message="  -Dphase.delay.seconds=5          Delay between phases" />
		<echo message="" />
		<echo message="DEPLOYMENT MODES (per service):" />
		<echo message="  -D&lt;service&gt;.mode=local           Launch service on this machine (default)" />
		<echo message="  -D&lt;service&gt;.mode=remote          Service runs on another machine (skip launch)" />
		<echo message="" />
		<echo message="  Services: triage, laboratory, radiology, cardiology, diagnosis, treatment, monitor" />
		<echo message="" />
		<echo message="EXAMPLES:" />
		<echo message="  ant -Dpatient.token.count=20 -Dcanary.token.count=5 -Dfederated.token.count=10" />
		<echo message="  ant -Dradiology.mode=remote -Dcardiology.mode=remote" />
		<echo message="  ant -Dtriage.mode=local -Dlaboratory.mode=remote  (mixed deployment)" />
		<echo message="" />
	</target>

</project>