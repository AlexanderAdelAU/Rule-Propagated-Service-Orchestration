<?xml version="1.0" encoding="UTF-8"?>

<project name="P1_P2_BuildAndRun" default="run-complete-workflow" basedir=".">
	<description>
		P1_P2 Petri Net - Complete Workflow with Initialization and Collection
		
		Phases:
		  Phase 1: Initialize Databases (purgeAndInitialize)
		  Phase 2: Execute Workflow (generate and process tokens)
		  Phase 3: Collect Performance Data

		TOKEN MODES:
		  Mode 1 (EDGE_NODE): Normal token firing - single tokens injected at P1
		  Mode 2 (JOIN_NODE): Join token firing - two tokens injected with paired IDs
		                      Uses -joinargs to specify paired token IDs (e.g., 1000001,1000002)

		Services (P1, P2, Monitor) start once and remain running throughout all phases.
	</description>

	<!-- ======================================================================= -->
	<!-- PROPERTIES                                                              -->
	<!-- ======================================================================= -->

	<!-- Rule version for workflow execution -->
	<property name="rule.version" value="v001" />

	<!-- Process names for each phase -->
	<property name="init.process.name" value="petrinet/Initializers/P1_P2_Initialization" />
	<property name="workflow.process.name" value="petrinet/Workflow/P1_P2_Workflow" />
	<property name="collector.process.name" value="petrinet/Collectors/P1_P2_Collector" />

	<!-- Phase 1: Initialization parameters (v999 = admin/non-instrumented) -->
	<property name="init.version" value="v999" />
	<property name="db.init.operation" value="purgeAndInitialize" />
	<property name="sequence.id.init.p1" value="999000000" />
	<property name="sequence.id.init.p2" value="999100000" />
	<property name="sequence.id.init.monitor" value="999600000" />
	<property name="init.delay.seconds" value="3" />

	<!-- Phase 2: Workflow parameters -->
	<property name="target.place" value="P1_Place" />
	<property name="target.operation" value="processToken" />
	<property name="token.expire" value="120000" />
	<property name="event.generator.id" value="P1_EVENTGENERATOR" />
	
	<!-- TOKEN MODE SELECTION: 1=EDGE_NODE (single tokens), 2=JOIN_NODE (paired tokens) -->
	<property name="mode" value="1" />
	<property name="token.count" value="10" />
	<property name="join.tokens" value="1000001,1000002" />
	
	<!-- Mode mapping (Ant condition) -->
	<condition property="token.mode" value="EDGE_NODE"><equals arg1="${mode}" arg2="1"/></condition>
	<condition property="token.mode" value="JOIN_NODE"><equals arg1="${mode}" arg2="2"/></condition>

	<!-- Phase 3: Collector parameters (v999 = admin/non-instrumented) -->
	<property name="collector.version" value="v999" />
	<property name="collector.operation" value="collectAllData" />
	<property name="query.version" value="v001" />
	<property name="sequence.id.collect.p1" value="999010000" />
	<property name="sequence.id.collect.p2" value="999020000" />
	<property name="collector.delay.seconds" value="3" />

	<!-- Timing parameters -->
	<property name="service.startup.seconds" value="3" />
	<property name="phase.delay.seconds" value="5" />
	<property name="port.release.seconds" value="5" />
	<property name="workflow.completion.seconds" value="5" />

	<!-- Base directories -->
	<property name="build.file.dir" location="." />
	<property name="petrinet.root.dir" location="../" />

	<!-- Common project -->
	<property name="common.project.dir" location="${petrinet.root.dir}/btsn.common" />
	<property name="lib.dir" location="${common.project.dir}/lib" />
	<property name="class.dir" location="${common.project.dir}/bin" />
	<property name="common.src.dir" location="${common.project.dir}/src" />

	<!-- Event Generators project -->
	<property name="generator.project.dir" location="${petrinet.root.dir}/btsn.common.eventgenerators" />
	<property name="generator.src.dir" location="${generator.project.dir}/src" />
	<property name="generator.bin.dir" location="${generator.project.dir}/bin" />

	<!-- Output directory -->
	<property name="output.dir" location="${build.file.dir}" />
	<property name="p1.output.file" location="${output.dir}/P1_Place.out.txt" />
	<property name="p2.output.file" location="${output.dir}/P2_Place.out.txt" />
	<property name="monitor.output.file" location="${output.dir}/MonitorService.out.txt" />

	<!-- P1 Service -->
	<property name="p1.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p1" />
	<property name="p1.bin.dir" location="${p1.project.dir}/bin" />
	<property name="p1.src.dir" location="${p1.project.dir}/src" />

	<!-- P2 Service -->
	<property name="p2.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p2" />
	<property name="p2.bin.dir" location="${p2.project.dir}/bin" />
	<property name="p2.src.dir" location="${p2.project.dir}/src" />

	<!-- Monitor Service -->
	<property name="monitor.project.dir" location="${petrinet.root.dir}/btsn.common.Monitor" />
	<property name="monitor.bin.dir" location="${monitor.project.dir}/bin" />
	<property name="monitor.src.dir" location="${monitor.project.dir}/src" />

	<!-- Java Classes -->
	<property name="service.loader.class" value="org.btsn.handlers.ServiceLoader" />
	<property name="init.event.generator.class" value="org.btsn.common.eventgenerators.DatabaseInitialization_EventGenerator" />
	<property name="token.generator.class" value="org.btsn.petrinet.eventgenerators.GenericPetriNetTokenGenerator" />
	<property name="collector.event.generator.class" value="org.btsn.common.eventgenerators.Common_Collector_EventGenerator" />

	<!-- ======================================================================= -->
	<!-- CLASSPATHS                                                              -->
	<!-- ======================================================================= -->

	<path id="common.classpath">
		<fileset dir="${lib.dir}" erroronmissingdir="false">
			<include name="*.jar" />
		</fileset>
		<pathelement location="${class.dir}" />
	</path>

	<path id="p1.classpath">
		<path refid="common.classpath" />
		<pathelement location="${p1.bin.dir}" />
	</path>

	<path id="p2.classpath">
		<path refid="common.classpath" />
		<pathelement location="${p2.bin.dir}" />
	</path>

	<path id="monitor.classpath">
		<path refid="common.classpath" />
		<pathelement location="${monitor.bin.dir}" />
	</path>

	<path id="generator.classpath">
		<path refid="common.classpath" />
		<pathelement location="${generator.bin.dir}" />
	</path>

	<!-- ======================================================================= -->
	<!-- UTILITY TARGETS                                                         -->
	<!-- ======================================================================= -->

	<target name="clean-output" description="Clean previous output files">
		<delete file="${p1.output.file}" quiet="true" />
		<delete file="${p2.output.file}" quiet="true" />
		<delete file="${monitor.output.file}" quiet="true" />
		<echo message="Previous output files cleaned" />
	</target>

	<target name="generate-workflow-bindings" description="Generate canonical bindings from workflow JSON">
		<echo message="=== Generating Workflow Bindings ===" />
		<java classname="org.btsn.rulecontroller.TopologyBindingGenerator" 
		      classpathref="generator.classpath"
		      dir="${common.project.dir}"
		      fork="true"
		      failonerror="true">
			<arg value="${workflow.process.name}" />
			<arg value="${rule.version}" />
		</java>
		<echo message="Workflow bindings generated successfully" />
	</target>

	<target name="rebuild-service-ruleml" depends="generate-workflow-bindings" 
	        description="Generate bindings and rebuild master Service.ruleml">
		<echo message="=== Building Master Service.ruleml ===" />
		<java classname="org.btsn.utils.BuildMasterServiceRuleBase" 
		      classpathref="generator.classpath"
		      dir="${common.project.dir}"
		      fork="true"
		      failonerror="true">
			<arg value="${rule.version}" />
			<arg value="ALL" />
		</java>
		<echo message="Master Service.ruleml built successfully" />
	</target>

	<!-- ======================================================================= -->
	<!-- TOKEN FIRING TARGETS (Mode-specific)                                    -->
	<!-- ======================================================================= -->

	<!-- Fire tokens for EDGE_NODE mode (single tokens) -->
	<target name="fire-tokens-EDGE_NODE">
		<echo message="Firing ${token.count} tokens to ${target.place}..." />
		<java classname="${token.generator.class}" 
		      fork="true" dir="${generator.project.dir}" failonerror="true">
			<classpath refid="generator.classpath" />
			<arg value="-version" /><arg value="${rule.version}" />
			<arg value="-process" /><arg value="${workflow.process.name}" />
			<arg value="-place" /><arg value="${target.place}" />
			<arg value="-operation" /><arg value="${target.operation}" />
			<arg value="-tokens" /><arg value="${token.count}" />
			<arg value="-expire" /><arg value="${token.expire}" />
			<arg value="-generator" /><arg value="${event.generator.id}" />
			<arg value="-skipdeploy" />
		</java>
	</target>

	<!-- Fire tokens for JOIN_NODE mode (paired join tokens) -->
	<target name="fire-tokens-JOIN_NODE">
		<echo message="Firing join tokens: ${join.tokens} to ${target.place}..." />
		<java classname="${token.generator.class}" 
		      fork="true" dir="${generator.project.dir}" failonerror="true">
			<classpath refid="generator.classpath" />
			<arg value="-version" /><arg value="${rule.version}" />
			<arg value="-process" /><arg value="${workflow.process.name}" />
			<arg value="-place" /><arg value="${target.place}" />
			<arg value="-operation" /><arg value="${target.operation}" />
			<arg value="-expire" /><arg value="${token.expire}" />
			<arg value="-generator" /><arg value="${event.generator.id}" />
			<arg value="-joinargs" /><arg value="${join.tokens}" />
			<arg value="-skipdeploy" />
		</java>
	</target>

	<!-- ======================================================================= -->
	<!-- MAIN TARGET: COMPLETE WORKFLOW                                          -->
	<!-- ======================================================================= -->

	<target name="run-complete-workflow" depends="clean-output,rebuild-service-ruleml" 
	        description="Run complete P1-P2 workflow with init, execution and collection (DEFAULT)">
		<echo message="" />
		<echo message="================================================================" />
		<echo message="  P1_P2 PETRI NET - COMPLETE WORKFLOW                          " />
		<echo message="================================================================" />
		<echo message="  Version: ${rule.version}" />
		<echo message="  Mode: ${token.mode}" />
		<echo message="  Target: ${target.place}:${target.operation}" />
		<echo message="  Event Generator: ${event.generator.id}" />
		<echo message="================================================================" />

		<parallel>
			<!-- Start P1 Service -->
			<java jvm="java.exe" classname="${service.loader.class}" 
			      fork="true" timeout="600000" 
			      dir="${p1.project.dir}" output="${p1.output.file}">
				<classpath refid="p1.classpath" />
				<arg value="${p1.project.dir}" />
				<arg value="-version" />
				<arg value="${rule.version}" />
			</java>

			<!-- Start P2 Service -->
			<java jvm="java.exe" classname="${service.loader.class}" 
			      fork="true" timeout="600000" 
			      dir="${p2.project.dir}" output="${p2.output.file}">
				<classpath refid="p2.classpath" />
				<arg value="${p2.project.dir}" />
				<arg value="-version" />
				<arg value="${rule.version}" />
			</java>

			<!-- Start Monitor Service -->
			<java jvm="java.exe" classname="${service.loader.class}" 
			      fork="true" timeout="600000" 
			      dir="${monitor.project.dir}" output="${monitor.output.file}">
				<classpath refid="monitor.classpath" />
				<arg value="${monitor.project.dir}" />
				<arg value="-version" />
				<arg value="${rule.version}" />
			</java>

			<sequential>
				<echo message="Waiting ${service.startup.seconds}s for services to start..." />
				<sleep seconds="${service.startup.seconds}" />

				<!-- ======================================================= -->
				<!-- PHASE 1: Database Initialization                        -->
				<!-- ======================================================= -->
				<echo message="" />
				<echo message="===============================================" />
				<echo message="    PHASE 1: DATABASE INITIALIZATION           " />
				<echo message="===============================================" />

				<!-- Deploy Initialization rules -->
				<echo message="Deploying Initialization rules..." />
				<java classname="${init.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P1_InitializationService" />
					<arg value="-operation" /><arg value="${db.init.operation}" />
					<arg value="-version" /><arg value="${init.version}" />
					<arg value="-process" /><arg value="${init.process.name}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.init.p1}" />
					<arg value="-tokens" /><arg value="1" />
				</java>

				<!-- Trigger P2 Initialization -->
				<java classname="${init.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P2_InitializationService" />
					<arg value="-operation" /><arg value="${db.init.operation}" />
					<arg value="-version" /><arg value="${init.version}" />
					<arg value="-process" /><arg value="${init.process.name}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.init.p2}" />
					<arg value="-tokens" /><arg value="1" />
					<arg value="-skipDeploy" />
				</java>

				<!-- Trigger Monitor Initialization -->
				<java classname="${init.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="Monitor_InitializationService" />
					<arg value="-operation" /><arg value="${db.init.operation}" />
					<arg value="-version" /><arg value="${init.version}" />
					<arg value="-process" /><arg value="${init.process.name}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.init.monitor}" />
					<arg value="-tokens" /><arg value="1" />
					<arg value="-skipDeploy" />
				</java>

				<echo message="Waiting ${init.delay.seconds}s for initialization to complete..." />
				<sleep seconds="${init.delay.seconds}" />
				<echo message="=== Phase 1 Complete ===" />
				<sleep seconds="${phase.delay.seconds}" />

				<!-- ======================================================= -->
				<!-- PHASE 2: Workflow Execution                             -->
				<!-- ======================================================= -->
				<echo message="" />
				<echo message="===============================================" />
				<echo message="    PHASE 2: WORKFLOW EXECUTION                " />
				<echo message="===============================================" />
				<echo message="Mode: ${token.mode}" />
				<echo message="Target: ${target.place}:${target.operation}" />
				<echo message="Event Generator: ${event.generator.id}" />

				<!-- Deploy Workflow rules (tokens=0) -->
				<echo message="Deploying Workflow rules..." />
				<java classname="${token.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-version" /><arg value="${rule.version}" />
					<arg value="-process" /><arg value="${workflow.process.name}" />
					<arg value="-place" /><arg value="${target.place}" />
					<arg value="-operation" /><arg value="${target.operation}" />
					<arg value="-tokens" /><arg value="0" />
					<arg value="-expire" /><arg value="${token.expire}" />
					<arg value="-generator" /><arg value="${event.generator.id}" />
				</java>

				<!-- Fire tokens based on mode -->
				<echo message="Firing tokens (Mode: ${token.mode})..." />
				<antcall target="fire-tokens-${token.mode}" />

				<echo message="=== Phase 2 Complete ===" />
				<sleep seconds="${phase.delay.seconds}" />

				<!-- ======================================================= -->
				<!-- PHASE 3: Data Collection                                -->
				<!-- ======================================================= -->
				<echo message="" />
				<echo message="===============================================" />
				<echo message="    PHASE 3: DATA COLLECTION                   " />
				<echo message="===============================================" />

				<!-- P1 Collection (with deployment) -->
				<echo message="Collecting from P1_CollectorService..." />
				<java classname="${collector.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P1_CollectorService" />
					<arg value="-operation" /><arg value="${collector.operation}" />
					<arg value="-version" /><arg value="${collector.version}" />
					<arg value="-process" /><arg value="${collector.process.name}" />
					<arg value="-queryVersion" /><arg value="${query.version}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.collect.p1}" />
				</java>
				<sleep seconds="${collector.delay.seconds}" />

				<!-- P2 Collection (skip deployment) -->
				<echo message="Collecting from P2_CollectorService..." />
				<java classname="${collector.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P2_CollectorService" />
					<arg value="-operation" /><arg value="${collector.operation}" />
					<arg value="-version" /><arg value="${collector.version}" />
					<arg value="-process" /><arg value="${collector.process.name}" />
					<arg value="-queryVersion" /><arg value="${query.version}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.collect.p2}" />
					<arg value="-skipDeploy" />
				</java>
				<echo message="=== Phase 3 Complete ===" />

				<!-- ======================================================= -->
				<!-- COMPLETE                                                -->
				<!-- ======================================================= -->
				<echo message="" />
				<echo message="================================================================" />
				<echo message="        P1_P2 WORKFLOW COMPLETED SUCCESSFULLY                  " />
				<echo message="================================================================" />
				<echo message="" />
				<echo message="Output files:" />
				<echo message="  P1: ${p1.output.file}" />
				<echo message="  P2: ${p2.output.file}" />
				<echo message="  Monitor: ${monitor.output.file}" />
				<echo message="" />
				<echo message="Services are still running. Press Ctrl+C to stop." />
			</sequential>
		</parallel>
	</target>

	<!-- ======================================================================= -->
	<!-- WORKFLOW-ONLY TARGET (skip init/collect)                               -->
	<!-- ======================================================================= -->

	<target name="run-workflow-only" depends="clean-output,rebuild-service-ruleml" 
	        description="Run only the workflow phase (skip init and collect)">
		<echo message="" />
		<echo message="================================================================" />
		<echo message="  P1_P2 PETRI NET - WORKFLOW ONLY                              " />
		<echo message="================================================================" />
		<echo message="  Mode: ${token.mode}" />
		<echo message="  Target: ${target.place}:${target.operation}" />
		<echo message="  Event Generator: ${event.generator.id}" />

		<parallel>
			<!-- Start services -->
			<java jvm="java.exe" classname="${service.loader.class}" 
			      fork="true" timeout="600000" 
			      dir="${p1.project.dir}" output="${p1.output.file}">
				<classpath refid="p1.classpath" />
				<arg value="${p1.project.dir}" />
				<arg value="-version" />
				<arg value="${rule.version}" />
			</java>

			<java jvm="java.exe" classname="${service.loader.class}" 
			      fork="true" timeout="600000" 
			      dir="${p2.project.dir}" output="${p2.output.file}">
				<classpath refid="p2.classpath" />
				<arg value="${p2.project.dir}" />
				<arg value="-version" />
				<arg value="${rule.version}" />
			</java>

			<java jvm="java.exe" classname="${service.loader.class}" 
			      fork="true" timeout="600000" 
			      dir="${monitor.project.dir}" output="${monitor.output.file}">
				<classpath refid="monitor.classpath" />
				<arg value="${monitor.project.dir}" />
				<arg value="-version" />
				<arg value="${rule.version}" />
			</java>

			<sequential>
				<sleep seconds="${service.startup.seconds}" />

				<!-- Deploy workflow rules -->
				<echo message="Deploying workflow rules..." />
				<java classname="${token.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-version" /><arg value="${rule.version}" />
					<arg value="-process" /><arg value="${workflow.process.name}" />
					<arg value="-place" /><arg value="${target.place}" />
					<arg value="-operation" /><arg value="${target.operation}" />
					<arg value="-tokens" /><arg value="0" />
					<arg value="-expire" /><arg value="${token.expire}" />
					<arg value="-generator" /><arg value="${event.generator.id}" />
				</java>

				<!-- Fire tokens based on mode -->
				<echo message="Firing tokens (Mode: ${token.mode})..." />
				<antcall target="fire-tokens-${token.mode}" />

				<echo message="Workflow running. Waiting ${workflow.completion.seconds} seconds..." />
				<sleep seconds="${workflow.completion.seconds}" />
				<echo message="Workflow complete. Services still running." />
			</sequential>
		</parallel>
	</target>

	<!-- ======================================================================= -->
	<!-- HELP TARGET                                                             -->
	<!-- ======================================================================= -->

	<target name="help" description="Display usage information">
		<echo message="" />
		<echo message="================================================================" />
		<echo message="  P1_P2 Petri Net - Complete Workflow                          " />
		<echo message="================================================================" />
		<echo message="" />
		<echo message="TOKEN MODES:" />
		<echo message="  Mode 1 (EDGE_NODE): Single token injection (default)" />
		<echo message="  Mode 2 (JOIN_NODE): Paired join tokens" />
		<echo message="" />
		<echo message="USAGE:" />
		<echo message="  ant                        Run complete workflow (default, EDGE_NODE)" />
		<echo message="  ant run-complete-workflow  Run complete workflow" />
		<echo message="  ant run-workflow-only      Skip init/collect phases" />
		<echo message="  ant help                   Show this help" />
		<echo message="" />
		<echo message="CONFIGURABLE PARAMETERS:" />
		<echo message="  -Drule.version=v001                    Rule base version" />
		<echo message="  -Dmode=1                               EDGE_NODE mode (default)" />
		<echo message="  -Dmode=2                               JOIN_NODE mode" />
		<echo message="  -Djoin.tokens=1000001,1000002          Join token IDs" />
		<echo message="  -Dtoken.count=10                       Tokens for EDGE_NODE mode" />
		<echo message="  -Dtarget.place=P1_Place                Target place name" />
		<echo message="  -Dtarget.operation=processToken        Service operation" />
		<echo message="  -Devent.generator.id=P1_EVENTGENERATOR Event generator ID" />
		<echo message="  -Dphase.delay.seconds=5                Delay between phases" />
		<echo message="  -Dquery.version=v001                   Version(s) to collect data from" />
		<echo message="  -Dworkflow.completion.seconds=5        Wait time after firing tokens" />
		<echo message="" />
		<echo message="EXAMPLES:" />
		<echo message="  ant                                    (EDGE_NODE with 10 tokens)" />
		<echo message="  ant -Dmode=1 -Dtoken.count=20          (EDGE_NODE with 20 tokens)" />
		<echo message="  ant -Dmode=2                           (JOIN_NODE with default IDs)" />
		<echo message="  ant -Dmode=2 -Djoin.tokens=2000001,2000002  (JOIN_NODE with custom IDs)" />
		<echo message="  ant run-workflow-only -Dmode=1 -Dtoken.count=100" />
		<echo message="" />
	</target>

</project>