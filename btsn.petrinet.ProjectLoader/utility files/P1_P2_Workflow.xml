<?xml version="1.0" encoding="UTF-8"?>
<project name="P1_P2_Workflow" default="load-all-services" basedir=".">
	<description>
        Phase 2: P1, P2 and Monitor Services - Workflow Execution
        Simple Loop Petri Net - Token Injection Workflow
    </description>

	<!-- =================================== -->
	<!-- PROPERTIES SECTION                 -->
	<!-- =================================== -->

	<!-- WORKFLOW PARAMETERS -->
	<property name="rule.version" value="v001" />
	<property name="process.name" value="petrinet/P1_P2_Workflow" />
	<property name="target.place" value="P1_Place" />
	<property name="token.count" value="10" />
	<property name="token.expire" value="120000" />
	<property name="sequence.id.workflow" value="1000000" />

	<!-- Timing -->
	<property name="port.release.seconds" value="5" />

	<!-- Base directories -->
	<property name="build.file.dir" location="." />
	<property name="petrinet.root.dir" location="../" />

	<!-- Common project directories -->
	<property name="common.project.dir" location="${petrinet.root.dir}/btsn.common" />
	<property name="lib.dir" location="${common.project.dir}/lib" />
	<property name="class.dir" location="${common.project.dir}/bin" />
	<property name="common.src.dir" location="${common.project.dir}/src" />

	<!-- Output directory (current directory) -->
	<property name="output.dir" location="${build.file.dir}" />

	<!-- P1 Service -->
	<property name="p1.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p1" />
	<property name="p1.bin.dir" location="${p1.project.dir}/bin" />
	<property name="p1.output.file" location="${output.dir}/P1_Place.out.txt" />

	<!-- P2 Service -->
	<property name="p2.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p2" />
	<property name="p2.bin.dir" location="${p2.project.dir}/bin" />
	<property name="p2.output.file" location="${output.dir}/P2_Place.out.txt" />

	<!-- Monitor Service -->
	<property name="monitor.project.dir" location="${petrinet.root.dir}/btsn.common.Monitor" />
	<property name="monitor.bin.dir" location="${monitor.project.dir}/bin" />
	<property name="monitor.output.file" location="${output.dir}/MonitorService.out.txt" />

	<!-- Event Generator -->
	<property name="generator.project.dir" location="${petrinet.root.dir}/btsn.common.eventgenerators" />
	<property name="generator.bin.dir" location="${generator.project.dir}/bin" />

	<!-- Java Classes -->
	<property name="service.loader.class" value="org.btsn.handlers.ServiceLoader" />
	<property name="token.generator.class" value="org.btsn.petrinet.eventgenerators.GenericPetriNetTokenGenerator" />

	<!-- =================================== -->
	<!-- CLASSPATH SECTION                  -->
	<!-- =================================== -->

	<path id="common.classpath">
		<fileset dir="${lib.dir}" erroronmissingdir="false">
			<include name="*.jar" />
		</fileset>
		<pathelement location="${class.dir}" />
	</path>

	<path id="p1.classpath">
		<path refid="common.classpath" />
		<pathelement location="${p1.bin.dir}" />
	</path>

	<path id="p2.classpath">
		<path refid="common.classpath" />
		<pathelement location="${p2.bin.dir}" />
	</path>

	<path id="monitor.classpath">
		<path refid="common.classpath" />
		<pathelement location="${monitor.bin.dir}" />
	</path>

	<path id="generator.classpath">
		<path refid="common.classpath" />
		<pathelement location="${generator.bin.dir}" />
	</path>

	<!-- =================================== -->
	<!-- UTILITY TARGETS                    -->
	<!-- =================================== -->

	<target name="kill-java-processes" description="Kill any lingering Java processes">
		<echo message="Killing any lingering Java processes..." />
		<exec executable="cmd" osfamily="windows" failonerror="false">
			<arg value="/c"/>
			<arg value="taskkill /F /IM java.exe /T 2>nul"/>
		</exec>
		<exec executable="bash" osfamily="unix" failonerror="false">
			<arg value="-c"/>
			<arg value="pkill -9 java 2>/dev/null || true"/>
		</exec>
		<echo message="Waiting ${port.release.seconds}s for ports to be released..." />
		<sleep seconds="${port.release.seconds}"/>
		<echo message="Process cleanup complete" />
	</target>

	<target name="clean-output" description="Clean previous output files">
		<delete file="${p1.output.file}" quiet="true" />
		<delete file="${p2.output.file}" quiet="true" />
		<delete file="${monitor.output.file}" quiet="true" />
		<echo message="Previous output files cleaned" />
	</target>

	<!-- =================================== -->
	<!-- RULE BASE BUILD TARGET             -->
	<!-- =================================== -->

	<target name="rebuild-service-ruleml" description="Rebuild master Service.ruleml from all service definitions">
		<echo message="=== Building Master Service.ruleml ===" />
		<java classname="org.btsn.utils.BuildMasterServiceRuleBase" 
		      classpathref="generator.classpath"
		      dir="${common.project.dir}"
		      fork="true"
		      failonerror="true">
			<arg value="${rule.version}" />
			<arg value="ALL" />
		</java>
		<echo message="Master Service.ruleml built successfully" />
	</target>

	<!-- =================================== -->
	<!-- SERVICE LOADING TARGETS            -->
	<!-- =================================== -->

	<target name="load-p1-service" description="Load P1_Place service">
		<echo message="Starting P1_Place service..." />
		<java classname="${service.loader.class}" 
		      fork="true" 
		      dir="${p1.project.dir}"
		      output="${p1.output.file}">
			<classpath refid="p1.classpath" />
			<arg value="${p1.project.dir}" />
			<arg value="-version" />
			<arg value="${rule.version}" />
			<arg value="-service" />
			<arg value="P1_Place" />
		</java>
	</target>

	<target name="load-p2-service" description="Load P2_Place service">
		<echo message="Starting P2_Place service..." />
		<java classname="${service.loader.class}" 
		      fork="true" 
		      dir="${p2.project.dir}"
		      output="${p2.output.file}">
			<classpath refid="p2.classpath" />
			<arg value="${p2.project.dir}" />
			<arg value="-version" />
			<arg value="${rule.version}" />
			<arg value="-service" />
			<arg value="P2_Place" />
		</java>
	</target>

	<target name="load-monitor-service" description="Load Monitor service">
		<echo message="Starting Monitor service..." />
		<java classname="${service.loader.class}" 
		      fork="true" 
		      dir="${monitor.project.dir}"
		      output="${monitor.output.file}">
			<classpath refid="monitor.classpath" />
			<arg value="${monitor.project.dir}" />
			<arg value="-version" />
			<arg value="${rule.version}" />
			<arg value="-service" />
			<arg value="MonitorService" />
		</java>
	</target>

	<!-- =================================== -->
	<!-- DEPLOY WORKFLOW RULES TARGET       -->
	<!-- =================================== -->

	<target name="deploy-workflow-rules" description="Deploy workflow rules (tokens=0)">
		<echo message="=== Deploying Workflow Rules ===" />
		<echo message="Process: ${process.name}" />
		<echo message="Version: ${rule.version}" />
		
		<java classname="${token.generator.class}" 
		      fork="true" 
		      dir="${generator.project.dir}"
		      failonerror="true">
			<classpath refid="generator.classpath" />
			<arg value="-version" />
			<arg value="${rule.version}" />
			<arg value="-process" />
			<arg value="${process.name}" />
			<arg value="-place" />
			<arg value="${target.place}" />
			<arg value="-sequenceId" />
			<arg value="${sequence.id.workflow}" />
			<arg value="-tokens" />
			<arg value="0" />
			<arg value="-expire" />
			<arg value="${token.expire}" />
		</java>
		<echo message="Workflow rules deployed." />
	</target>

	<!-- =================================== -->
	<!-- TOKEN FIRING TARGET                -->
	<!-- =================================== -->

	<target name="fire-tokens" description="Fire tokens to start workflow">
		<echo message="=== Firing Tokens ===" />
		<echo message="Target Place: ${target.place}" />
		<echo message="Token Count: ${token.count}" />
		<echo message="Token Expire: ${token.expire}ms" />
		
		<java classname="${token.generator.class}" 
		      fork="true" 
		      dir="${generator.project.dir}"
		      failonerror="true">
			<classpath refid="generator.classpath" />
			<arg value="-version" />
			<arg value="${rule.version}" />
			<arg value="-process" />
			<arg value="${process.name}" />
			<arg value="-place" />
			<arg value="${target.place}" />
			<arg value="-sequenceId" />
			<arg value="${sequence.id.workflow}" />
			<arg value="-tokens" />
			<arg value="${token.count}" />
			<arg value="-expire" />
			<arg value="${token.expire}" />
			<arg value="-skipdeploy" />
		</java>
		<echo message="Tokens fired." />
	</target>

	<!-- =================================== -->
	<!-- WORKFLOW EXECUTION TARGET          -->
	<!-- =================================== -->

	<target name="execute-workflow" description="Deploy rules and fire tokens">
		<echo message="=== DEPLOYING WORKFLOW RULES FIRST ===" />
		<antcall target="deploy-workflow-rules" />
		
		<echo message="=== FIRING TOKENS ===" />
		<antcall target="fire-tokens" />	
		<echo message="=== WORKFLOW EXECUTION TRIGGERED ===" />
	</target>

	<!-- =================================== -->
	<!-- MAIN TARGET                         -->
	<!-- =================================== -->

	<target name="load-all-services" 
	        depends="kill-java-processes,clean-output,rebuild-service-ruleml" 
	        description="Load all services and execute workflow (DEFAULT)">
		<echo message="=== WORKFLOW: LOADING ALL SERVICES ===" />
		<echo message="Rule version: ${rule.version}" />
		<echo message="Process Name: ${process.name}" />
		<echo message="Target Place: ${target.place}" />
		<echo message="Token Count: ${token.count}" />
		<echo message="" />

		<!-- Start all services in parallel -->
		<parallel timeout="120000">
			<antcall target="load-p1-service" />
			<antcall target="load-p2-service" />
			<antcall target="load-monitor-service" />

			<sequential>
				<echo message="Waiting for services to initialize..." />
				<sleep seconds="2" />
				<antcall target="execute-workflow" />
				<echo message="" />
				<sleep seconds="20" />
				<echo message="Workflow complete. Killing services..." />
				<sleep seconds="2" />
				<antcall target="kill-java-processes" />
			</sequential>
		</parallel>

		<echo message="" />
		<echo message="=== WORKFLOW COMPLETE ===" />
		<echo message="Run P1_P2_Collection.xml next." />
	</target>

	<!-- =================================== -->
	<!-- HELP TARGET                        -->
	<!-- =================================== -->

	<target name="help" description="Display available targets">
		<echo message="=== PHASE 2: P1-P2 WORKFLOW ===" />
		<echo message="" />
		<echo message="MAIN TARGET:" />
		<echo message="  load-all-services    - Kill processes, load services, execute workflow (DEFAULT)" />
		<echo message="" />
		<echo message="INDIVIDUAL TARGETS:" />
		<echo message="  kill-java-processes  - Kill any lingering Java processes" />
		<echo message="  deploy-workflow-rules - Deploy workflow rules only" />
		<echo message="  fire-tokens          - Fire tokens only (assumes rules deployed)" />
		<echo message="  execute-workflow     - Deploy rules and fire tokens" />
		<echo message="" />
		<echo message="PARAMETERS:" />
		<echo message="  rule.version       = ${rule.version}" />
		<echo message="  process.name       = ${process.name}" />
		<echo message="  target.place       = ${target.place}" />
		<echo message="  token.count        = ${token.count}" />
		<echo message="  token.expire       = ${token.expire}" />
		<echo message="" />
		<echo message="USAGE:" />
		<echo message="  ant -f P1_P2_Workflow.xml" />
		<echo message="  ant -f P1_P2_Workflow.xml -Dtoken.count=10" />
		<echo message="" />
	</target>

</project>