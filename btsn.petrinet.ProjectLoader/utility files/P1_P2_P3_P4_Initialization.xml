<?xml version="1.0" encoding="UTF-8"?>
<project name="P1_P2_P3_P4_Phase1_Initialization_v999" default="initialize-all" basedir=".">
    <description>
        Phase 1: Database Initialization for P1-P4 and Monitor Services
        P1_P2_P3_P4 Petri Net - Database Initialization Workflow
        
        TWO-PHASE APPROACH:
        Phase 1A: Load InitializationServices → Trigger purge → Kill services
        Phase 1B: (Optional) Verify database is clean
        
        Then run P1_P2_P3_P4_Workflow.xml to start main services.
        
        ADMIN VERSION (v999): Instrumentation is DISABLED for these tokens.
    </description>

    <!-- =================================== -->
    <!-- PROPERTIES SECTION                 -->
    <!-- =================================== -->

    <property name="rule.version" value="v999" />
    <property name="sequence.id.p1" value="999000000" />
    <property name="sequence.id.p2" value="999100000" />
    <property name="sequence.id.p3" value="999200000" />
    <property name="sequence.id.p4" value="999300000" />
    <property name="sequence.id.monitor" value="999400000" />
    <property name="db.init.operation" value="purgeAndInitialize" />
    <property name="process.name" value="petrinet/P1_P2_P3_P4_Initialization" />

    <!-- Timing -->
    <property name="port.release.seconds" value="5" />
    <property name="service.startup.seconds" value="3" />
    <property name="init.completion.seconds" value="5" />

    <!-- Base directories -->
    <property name="build.file.dir" location="." />
    <property name="petrinet.root.dir" location="../" />

    <!-- Common project directories -->
    <property name="common.project.dir" location="${petrinet.root.dir}/btsn.common" />
    <property name="lib.dir" location="${common.project.dir}/lib" />
    <property name="class.dir" location="${common.project.dir}/bin" />

    <!-- Output directory -->
    <property name="output.dir" location="${build.file.dir}" />

    <!-- Service project directories -->
    <property name="p1.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p1" />
    <property name="p1.bin.dir" location="${p1.project.dir}/bin" />
    <property name="p1.init.output.file" location="${output.dir}/P1_InitializationService.out.txt" />

    <property name="p2.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p2" />
    <property name="p2.bin.dir" location="${p2.project.dir}/bin" />
    <property name="p2.init.output.file" location="${output.dir}/P2_InitializationService.out.txt" />

    <property name="p3.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p3" />
    <property name="p3.bin.dir" location="${p3.project.dir}/bin" />
    <property name="p3.init.output.file" location="${output.dir}/P3_InitializationService.out.txt" />

    <property name="p4.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p4" />
    <property name="p4.bin.dir" location="${p4.project.dir}/bin" />
    <property name="p4.init.output.file" location="${output.dir}/P4_InitializationService.out.txt" />

    <property name="monitor.project.dir" location="${petrinet.root.dir}/btsn.common.Monitor" />
    <property name="monitor.bin.dir" location="${monitor.project.dir}/bin" />
    <property name="monitor.init.output.file" location="${output.dir}/Monitor_InitializationService.out.txt" />

    <!-- Event Generator -->
    <property name="generator.project.dir" location="${petrinet.root.dir}/btsn.common.eventgenerators" />
    <property name="generator.bin.dir" location="${generator.project.dir}/bin" />

    <!-- Java Classes -->
    <property name="service.loader.class" value="org.btsn.handlers.ServiceLoader" />
    <property name="event.generator.class" value="org.btsn.common.eventgenerators.DatabaseInitialization_EventGenerator" />

    <!-- =================================== -->
    <!-- CLASSPATH SECTION                  -->
    <!-- =================================== -->

    <path id="common.classpath">
        <fileset dir="${lib.dir}" erroronmissingdir="false">
            <include name="*.jar" />
        </fileset>
        <pathelement location="${class.dir}" />
    </path>

    <path id="p1.classpath">
        <path refid="common.classpath" />
        <pathelement location="${p1.bin.dir}" />
    </path>

    <path id="p2.classpath">
        <path refid="common.classpath" />
        <pathelement location="${p2.bin.dir}" />
    </path>

    <path id="p3.classpath">
        <path refid="common.classpath" />
        <pathelement location="${p3.bin.dir}" />
    </path>

    <path id="p4.classpath">
        <path refid="common.classpath" />
        <pathelement location="${p4.bin.dir}" />
    </path>

    <path id="monitor.classpath">
        <path refid="common.classpath" />
        <pathelement location="${monitor.bin.dir}" />
    </path>

    <path id="generator.classpath">
        <path refid="common.classpath" />
        <pathelement location="${generator.bin.dir}" />
    </path>

    <!-- =================================== -->
    <!-- UTILITY TARGETS                    -->
    <!-- =================================== -->

    <target name="kill-java-processes" description="Kill any lingering Java processes">
        <echo message="Killing any lingering Java processes..." />
        <exec executable="cmd" osfamily="windows" failonerror="false">
            <arg value="/c"/>
            <arg value="taskkill /F /IM java.exe /T 2>nul"/>
        </exec>
        <exec executable="bash" osfamily="unix" failonerror="false">
            <arg value="-c"/>
            <arg value="pkill -9 java 2>/dev/null || true"/>
        </exec>
        <echo message="Waiting ${port.release.seconds}s for ports to be released..." />
        <sleep seconds="${port.release.seconds}"/>
        <echo message="Process cleanup complete" />
    </target>

    <target name="clean-output" description="Clean previous output files">
        <delete file="${p1.init.output.file}" quiet="true" />
        <delete file="${p2.init.output.file}" quiet="true" />
        <delete file="${p3.init.output.file}" quiet="true" />
        <delete file="${p4.init.output.file}" quiet="true" />
        <delete file="${monitor.init.output.file}" quiet="true" />
        <echo message="Previous initialization output files cleaned" />
    </target>

    <!-- =================================== -->
    <!-- LOAD INITIALIZATION SERVICES       -->
    <!-- These load P1_InitializationService, NOT P1_Place -->
    <!-- =================================== -->

    <target name="load-p1-init-service" description="Load P1_InitializationService">
        <echo message="Starting P1_InitializationService..." />
        <java classname="${service.loader.class}" 
              fork="true" 
              dir="${p1.project.dir}"
              output="${p1.init.output.file}">
            <classpath refid="p1.classpath" />
            <arg value="${p1.project.dir}" />
            <arg value="-version" />
            <arg value="${rule.version}" />
            <arg value="-service" />
            <arg value="P1_InitializationService" />
        </java>
    </target>

    <target name="load-p2-init-service" description="Load P2_InitializationService">
        <echo message="Starting P2_InitializationService..." />
        <java classname="${service.loader.class}" 
              fork="true" 
              dir="${p2.project.dir}"
              output="${p2.init.output.file}">
            <classpath refid="p2.classpath" />
            <arg value="${p2.project.dir}" />
            <arg value="-service" />
            <arg value="P2_InitializationService" />
            <arg value="-version" />
            <arg value="${rule.version}" />
        </java>
    </target>

    <target name="load-p3-init-service" description="Load P3_InitializationService">
        <echo message="Starting P3_InitializationService..." />
        <java classname="${service.loader.class}" 
              fork="true" 
              dir="${p3.project.dir}"
              output="${p3.init.output.file}">
            <classpath refid="p3.classpath" />
            <arg value="${p3.project.dir}" />
            <arg value="-service" />
            <arg value="P3_InitializationService" />
            <arg value="-version" />
            <arg value="${rule.version}" />
        </java>
    </target>

    <target name="load-p4-init-service" description="Load P4_InitializationService">
        <echo message="Starting P4_InitializationService..." />
        <java classname="${service.loader.class}" 
              fork="true" 
              dir="${p4.project.dir}"
              output="${p4.init.output.file}">
            <classpath refid="p4.classpath" />
            <arg value="${p4.project.dir}" />
            <arg value="-service" />
            <arg value="P4_InitializationService" />
            <arg value="-version" />
            <arg value="${rule.version}" />
        </java>
    </target>

    <target name="load-monitor-init-service" description="Load Monitor_InitializationService">
        <echo message="Starting Monitor_InitializationService..." />
        <java classname="${service.loader.class}" 
              fork="true" 
              dir="${monitor.project.dir}"
              output="${monitor.init.output.file}">
            <classpath refid="monitor.classpath" />
            <arg value="${monitor.project.dir}" />
            <arg value="-service" />
            <arg value="Monitor_InitializationService" />
            <arg value="-version" />
            <arg value="${rule.version}" />
        </java>
    </target>

    <!-- =================================== -->
    <!-- DEPLOY PROCESS RULES TARGET        -->
    <!-- =================================== -->

    <target name="deploy-process-rules" description="Deploy process rules for initialization">
        <echo message="=== Deploying Process Rules ===" />
        <echo message="Process: ${process.name}" />
        <echo message="Version: ${rule.version}" />
        
        <java classname="${event.generator.class}" 
              fork="true" 
              dir="${generator.project.dir}"
              failonerror="true">
            <classpath refid="generator.classpath" />
            <arg value="-service" /><arg value="P1_InitializationService" />
            <arg value="-operation" /><arg value="${db.init.operation}" />
            <arg value="-version" /><arg value="${rule.version}" />
            <arg value="-process" /><arg value="${process.name}" />
            <arg value="-sequenceId" /><arg value="${sequence.id.p1}" />
            <arg value="-tokens" /><arg value="0" />
        </java>
        <echo message="Process rules deployed." />
    </target>

    <!-- =================================== -->
    <!-- TRIGGER INITIALIZATION EVENTS      -->
    <!-- =================================== -->

    <target name="trigger-p1-initializer" description="Trigger P1 Initialization">
        <echo message="Triggering P1 purgeAndInitialize..." />
        <java classname="${event.generator.class}" 
              fork="true" 
              dir="${generator.project.dir}"
              failonerror="true">
            <classpath refid="generator.classpath" />
            <arg value="-service" /><arg value="P1_InitializationService" />
            <arg value="-operation" /><arg value="${db.init.operation}" />
            <arg value="-version" /><arg value="${rule.version}" />
            <arg value="-process" /><arg value="${process.name}" />
            <arg value="-sequenceId" /><arg value="${sequence.id.p1}" />
            <arg value="-tokens" /><arg value="1" />
            <arg value="-skipDeploy" />
        </java>
    </target>

    <target name="trigger-p2-initializer" description="Trigger P2 Initialization">
        <echo message="Triggering P2 purgeAndInitialize..." />
        <java classname="${event.generator.class}" 
              fork="true" 
              dir="${generator.project.dir}"
              failonerror="true">
            <classpath refid="generator.classpath" />
            <arg value="-service" /><arg value="P2_InitializationService" />
            <arg value="-operation" /><arg value="${db.init.operation}" />
            <arg value="-version" /><arg value="${rule.version}" />
            <arg value="-process" /><arg value="${process.name}" />
            <arg value="-sequenceId" /><arg value="${sequence.id.p2}" />
            <arg value="-tokens" /><arg value="1" />
            <arg value="-skipDeploy" />
        </java>
    </target>

    <target name="trigger-p3-initializer" description="Trigger P3 Initialization">
        <echo message="Triggering P3 purgeAndInitialize..." />
        <java classname="${event.generator.class}" 
              fork="true" 
              dir="${generator.project.dir}"
              failonerror="true">
            <classpath refid="generator.classpath" />
            <arg value="-service" /><arg value="P3_InitializationService" />
            <arg value="-operation" /><arg value="${db.init.operation}" />
            <arg value="-version" /><arg value="${rule.version}" />
            <arg value="-process" /><arg value="${process.name}" />
            <arg value="-sequenceId" /><arg value="${sequence.id.p3}" />
            <arg value="-tokens" /><arg value="1" />
            <arg value="-skipDeploy" />
        </java>
    </target>

    <target name="trigger-p4-initializer" description="Trigger P4 Initialization">
        <echo message="Triggering P4 purgeAndInitialize..." />
        <java classname="${event.generator.class}" 
              fork="true" 
              dir="${generator.project.dir}"
              failonerror="true">
            <classpath refid="generator.classpath" />
            <arg value="-service" /><arg value="P4_InitializationService" />
            <arg value="-operation" /><arg value="${db.init.operation}" />
            <arg value="-version" /><arg value="${rule.version}" />
            <arg value="-process" /><arg value="${process.name}" />
            <arg value="-sequenceId" /><arg value="${sequence.id.p4}" />
            <arg value="-tokens" /><arg value="1" />
            <arg value="-skipDeploy" />
        </java>
    </target>

    <target name="trigger-monitor-initializer" description="Trigger Monitor Initialization">
        <echo message="Triggering Monitor purgeAndInitialize..." />
        <java classname="${event.generator.class}" 
              fork="true" 
              dir="${generator.project.dir}"
              failonerror="true">
            <classpath refid="generator.classpath" />
            <arg value="-service" /><arg value="Monitor_InitializationService" />
            <arg value="-operation" /><arg value="${db.init.operation}" />
            <arg value="-version" /><arg value="${rule.version}" />
            <arg value="-process" /><arg value="${process.name}" />
            <arg value="-sequenceId" /><arg value="${sequence.id.monitor}" />
            <arg value="-tokens" /><arg value="1" />
            <arg value="-skipDeploy" />
        </java>
    </target>

    <!-- =================================== -->
    <!-- MAIN INITIALIZATION TARGET         -->
    <!-- =================================== -->

    <target name="initialize-all" 
            depends="kill-java-processes,clean-output" 
            description="Initialize all databases (DEFAULT)">
        
        <echo message="" />
        <echo message="╔════════════════════════════════════════════════════════════╗" />
        <echo message="║  PHASE 1A: LOADING INITIALIZATION SERVICES                 ║" />
        <echo message="╠════════════════════════════════════════════════════════════╣" />
        <echo message="║  Rule version: ${rule.version}                                       ║" />
        <echo message="║  Operation: ${db.init.operation}                              ║" />
        <echo message="╚════════════════════════════════════════════════════════════╝" />
        <echo message="" />

        <!-- Start ONLY initialization services in parallel -->
        <parallel timeout="120000">
            <!-- Load all initialization services -->
            <antcall target="load-p1-init-service" />
            <antcall target="load-p2-init-service" />
            <antcall target="load-p3-init-service" />
            <antcall target="load-p4-init-service" />
            <antcall target="load-monitor-init-service" />

            <!-- Sequential: wait for startup, trigger init, wait for completion, kill -->
            <sequential>
                <echo message="" />
                <echo message="Waiting ${service.startup.seconds}s for initialization services to start..." />
                <sleep seconds="${service.startup.seconds}" />

                <echo message="" />
                <echo message="╔════════════════════════════════════════════════════════════╗" />
                <echo message="║  PHASE 1B: DEPLOYING PROCESS RULES                         ║" />
                <echo message="╚════════════════════════════════════════════════════════════╝" />
                <echo message="" />
                
                <antcall target="deploy-process-rules" />

                <echo message="" />
                <echo message="╔════════════════════════════════════════════════════════════╗" />
                <echo message="║  PHASE 1C: TRIGGERING DATABASE INITIALIZATION              ║" />
                <echo message="╚════════════════════════════════════════════════════════════╝" />
                <echo message="" />

                <!-- Trigger all initializers in parallel -->
                <parallel>
                    <antcall target="trigger-p1-initializer" />
                    <antcall target="trigger-p2-initializer" />
                    <antcall target="trigger-p3-initializer" />
                    <antcall target="trigger-p4-initializer" />
                    <antcall target="trigger-monitor-initializer" />
                </parallel>

                <echo message="" />
                <echo message="Waiting ${init.completion.seconds}s for initialization to complete..." />
                <sleep seconds="${init.completion.seconds}" />

                <echo message="" />
                <echo message="╔════════════════════════════════════════════════════════════╗" />
                <echo message="║  PHASE 1D: STOPPING INITIALIZATION SERVICES                ║" />
                <echo message="╚════════════════════════════════════════════════════════════╝" />
                <echo message="" />
                
                <antcall target="kill-java-processes" />
            </sequential>
        </parallel>

        <echo message="" />
        <echo message="╔════════════════════════════════════════════════════════════╗" />
        <echo message="║  ✓ DATABASE INITIALIZATION COMPLETE                        ║" />
        <echo message="╠════════════════════════════════════════════════════════════╣" />
        <echo message="║  Check output files for results:                           ║" />
        <echo message="║    - P1_InitializationService.out.txt                      ║" />
        <echo message="║    - P2_InitializationService.out.txt                      ║" />
        <echo message="║    - P3_InitializationService.out.txt                      ║" />
        <echo message="║    - P4_InitializationService.out.txt                      ║" />
        <echo message="║    - Monitor_InitializationService.out.txt                 ║" />
        <echo message="║                                                            ║" />
        <echo message="║  Next: Run P1_P2_P3_P4_Workflow.xml to start services      ║" />
        <echo message="╚════════════════════════════════════════════════════════════╝" />
    </target>

    <!-- =================================== -->
    <!-- HELP TARGET                        -->
    <!-- =================================== -->

    <target name="help" description="Display available targets">
        <echo message="" />
        <echo message="=== P1_P2_P3_P4 DATABASE INITIALIZATION ===" />
        <echo message="" />
        <echo message="MAIN TARGET:" />
        <echo message="  initialize-all       - Initialize all databases (DEFAULT)" />
        <echo message="" />
        <echo message="This script:" />
        <echo message="  1. Kills any lingering processes" />
        <echo message="  2. Loads P1-P4 and Monitor INITIALIZATION services" />
        <echo message="  3. Triggers purgeAndInitialize on each" />
        <echo message="  4. Kills initialization services" />
        <echo message="" />
        <echo message="After this completes, run P1_P2_P3_P4_Workflow.xml" />
        <echo message="to start the main P1_Place, P2_Place, etc. services." />
        <echo message="" />
        <echo message="PARAMETERS:" />
        <echo message="  rule.version       = ${rule.version}" />
        <echo message="  db.init.operation  = ${db.init.operation}" />
        <echo message="" />
        <echo message="USAGE:" />
        <echo message="  ant -f P1_P2_P3_P4_Initialization.xml" />
        <echo message="" />
    </target>

</project>