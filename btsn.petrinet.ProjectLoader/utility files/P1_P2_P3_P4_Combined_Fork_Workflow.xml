<?xml version="1.0" encoding="UTF-8"?>
<project name="P1_P2_P3_P4_Complete_Workflow" default="run-complete-workflow" basedir=".">
	<description>
		CONSOLIDATED Petri Net Fork/Join Workflow - P1, P2, P3, P4, Monitor
		
		Workflow: P1 -> XOR Fork -> (P2 + P3) -> Join -> P4 -> Monitor
		                    |
		                    +-> (false) -> Monitor (bypass)
		
		Services (P1, P2, P3, P4, Monitor) start once and remain running throughout all phases:
		  Phase 1: Initialize Databases (purgeAndInitialize)
		  Phase 2: Execute Fork/Join Workflow (generate and process tokens)
		  Phase 3: Collect Performance Data
	</description>

	<!-- ======================================================================= -->
	<!-- PROPERTIES                                                              -->
	<!-- ======================================================================= -->

	<!-- Rule version (applies to all phases) -->
	<property name="rule.version" value="v001" />

	<!-- Process names for each phase -->
	<property name="init.process.name" value="petrinet/P1_P2_P3_P4_Initialization" />
	<property name="workflow.process.name" value="petrinet/P1_P2_P3_P4_Fork_Workflow" />
	<property name="collector.process.name" value="petrinet/P1_P2_P3_P4_Collector" />

	<!-- Phase 1: Initialization parameters -->
	<property name="db.init.operation" value="purgeAndInitialize" />
	<property name="sequence.id.init.p1" value="999100000" />
	<property name="sequence.id.init.p2" value="999200000" />
	<property name="sequence.id.init.p3" value="999300000" />
	<property name="sequence.id.init.p4" value="999400000" />
	<property name="sequence.id.init.monitor" value="999500000" />
		

	<!-- Phase 2: Workflow parameters -->
	<property name="target.place" value="P1_Place" />
	<property name="token.count" value="10" />
	<property name="token.expire" value="120000" />

	<!-- Phase 3: Collector parameters -->
	<property name="service.operation" value="collectAllData" />
	<property name="query.version" value="v001" />
	<property name="sequence.id.collect.p1" value="1000000" />
	<property name="sequence.id.collect.p2" value="2000000" />
	<property name="sequence.id.collect.p3" value="3000000" />
	<property name="sequence.id.collect.p4" value="4000000" />

	<!-- Timing parameters -->
	<property name="service.startup.seconds" value="3" />
	<property name="phase.delay.seconds" value="5" />
	<property name="collector.delay.seconds" value="3" />

	<!-- Base directories -->
	<property name="build.file.dir" location="." />
	<property name="petrinet.root.dir" location="../" />

	<!-- Common project -->
	<property name="common.project.dir" location="${petrinet.root.dir}/btsn.common" />
	<property name="lib.dir" location="${common.project.dir}/lib" />
	<property name="class.dir" location="${common.project.dir}/bin" />
	<property name="common.src.dir" location="${common.project.dir}/src" />

	<!-- Output directory -->
	<property name="output.dir" location="${build.file.dir}" />
	<property name="p1.output.file" location="${output.dir}/P1_Place.out.txt" />
	<property name="p2.output.file" location="${output.dir}/P2_Place.out.txt" />
	<property name="p3.output.file" location="${output.dir}/P3_Place.out.txt" />
	<property name="p4.output.file" location="${output.dir}/P4_Place.out.txt" />
	<property name="monitor.output.file" location="${output.dir}/MonitorService.out.txt" />

	<!-- P1 Service -->
	<property name="p1.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p1" />
	<property name="p1.bin.dir" location="${p1.project.dir}/bin" />
	<property name="p1.src.dir" location="${p1.project.dir}/src" />

	<!-- P2 Service -->
	<property name="p2.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p2" />
	<property name="p2.bin.dir" location="${p2.project.dir}/bin" />
	<property name="p2.src.dir" location="${p2.project.dir}/src" />

	<!-- P3 Service -->
	<property name="p3.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p3" />
	<property name="p3.bin.dir" location="${p3.project.dir}/bin" />
	<property name="p3.src.dir" location="${p3.project.dir}/src" />

	<!-- P4 Service -->
	<property name="p4.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p4" />
	<property name="p4.bin.dir" location="${p4.project.dir}/bin" />
	<property name="p4.src.dir" location="${p4.project.dir}/src" />

	<!-- Monitor Service (in btsn.common.Monitor) -->
	<property name="monitor.project.dir" location="${petrinet.root.dir}/btsn.common.Monitor" />
	<property name="monitor.bin.dir" location="${monitor.project.dir}/bin" />
	<property name="monitor.src.dir" location="${monitor.project.dir}/src" />

	<!-- Event Generators (in btsn.common.eventgenerators - sibling to btsn.common) -->
	<property name="generator.project.dir" location="${petrinet.root.dir}/btsn.common.eventgenerators" />
	<property name="generator.src.dir" location="${generator.project.dir}/src" />
	<property name="generator.bin.dir" location="${generator.project.dir}/bin" />

	<!-- Java Classes -->
	<property name="service.loader.class" value="org.btsn.handlers.ServiceLoader" />
	<property name="init.event.generator.class" value="org.btsn.common.eventgenerators.DatabaseInitialization_EventGenerator" />
	<property name="token.generator.class" value="org.btsn.petrinet.eventgenerators.GenericPetriNetTokenGenerator" />
	<property name="collector.event.generator.class" value="org.btsn.common.eventgenerators.Common_Collector_EventGenerator" />

	<!-- ======================================================================= -->
	<!-- CLASSPATHS                                                              -->
	<!-- ======================================================================= -->

	<path id="common.classpath">
		<fileset dir="${lib.dir}" erroronmissingdir="false">
			<include name="*.jar" />
		</fileset>
		<pathelement location="${class.dir}" />
	</path>

	<path id="p1.classpath">
		<path refid="common.classpath" />
		<pathelement location="${p1.bin.dir}" />
	</path>

	<path id="p2.classpath">
		<path refid="common.classpath" />
		<pathelement location="${p2.bin.dir}" />
	</path>

	<path id="p3.classpath">
		<path refid="common.classpath" />
		<pathelement location="${p3.bin.dir}" />
	</path>

	<path id="p4.classpath">
		<path refid="common.classpath" />
		<pathelement location="${p4.bin.dir}" />
	</path>

	<path id="monitor.classpath">
		<path refid="common.classpath" />
		<pathelement location="${monitor.bin.dir}" />
	</path>

	<path id="generator.classpath">
		<path refid="common.classpath" />
		<pathelement location="${generator.bin.dir}" />
	</path>

	<!-- ======================================================================= -->
	<!-- UTILITY TARGETS                                                         -->
	<!-- ======================================================================= -->

	<target name="clean-output" description="Clean previous output files">
		<delete file="${p1.output.file}" quiet="true" />
		<delete file="${p2.output.file}" quiet="true" />
		<delete file="${p3.output.file}" quiet="true" />
		<delete file="${p4.output.file}" quiet="true" />
		<delete file="${monitor.output.file}" quiet="true" />
		<echo message="Previous output files cleaned" />
	</target>

	<target name="compile-common" description="Compile common classes">
		<echo message="Compiling common classes..." />
		<mkdir dir="${class.dir}" />
		<javac srcdir="${common.src.dir}" 
		       destdir="${class.dir}" 
		       classpathref="common.classpath"
		       includeantruntime="false"
		       fork="true"
		       source="15"
		       target="15"
		       failonerror="true"
		       verbose="false"
		       listfiles="false">
			<compilerarg value="-Xlint:unchecked" />
		</javac>
		<echo message="Common classes compiled successfully" />
	</target>

	<target name="compile-generator" depends="compile-common" description="Compile event generator classes">
		<echo message="Compiling event generator classes..." />
		<mkdir dir="${generator.bin.dir}" />
		<javac srcdir="${generator.src.dir}" 
		       destdir="${generator.bin.dir}" 
		       classpathref="common.classpath"
		       includeantruntime="false"
		       fork="true"
		       source="15"
		       target="15"
		       failonerror="true">
			<compilerarg value="-Xlint:unchecked" />
		</javac>
		<echo message="Event generator classes compiled successfully" />
	</target>

	<target name="compile-monitor" depends="compile-common" description="Compile Monitor service classes">
		<echo message="Compiling Monitor service classes..." />
		<mkdir dir="${monitor.bin.dir}" />
		<javac srcdir="${monitor.src.dir}" 
		       destdir="${monitor.bin.dir}" 
		       classpathref="common.classpath"
		       includeantruntime="false"
		       fork="true"
		       source="15"
		       target="15"
		       failonerror="true">
			<compilerarg value="-Xlint:unchecked" />
		</javac>
		<echo message="Monitor service classes compiled successfully" />
	</target>

	<target name="rebuild-service-ruleml" depends="compile-common,compile-generator,compile-monitor" 
	        description="Build the master Service.ruleml">
		<echo message="Building master Service.ruleml..." />
		<java classname="org.btsn.utils.BuildMasterServiceRuleBase" 
		      classpathref="generator.classpath"
		      dir="${common.project.dir}"
		      fork="true"
		      failonerror="true">
			<arg value="${rule.version}" />
			<arg value="ALL" />
		</java>
		<echo message="Master Service.ruleml built successfully" />
	</target>

	<!-- ======================================================================= -->
	<!-- MAIN WORKFLOW TARGET                                                    -->
	<!-- ======================================================================= -->

	<target name="run-complete-workflow" depends="clean-output,rebuild-service-ruleml"
	        description="Run complete P1_P2_P3_P4 Fork/Join workflow with all phases">

		<echo message="================================================================" />
		<echo message="  P1_P2_P3_P4 FORK/JOIN WORKFLOW - SERVICES LOADED ONCE        " />
		<echo message="================================================================" />
		<echo message="  Rule Version: ${rule.version}" />
		<echo message="  Phase 1: Initialize Databases (P1, P2, P3, P4, Monitor)" />
		<echo message="  Phase 2: Execute Fork/Join Workflow (${token.count} tokens)" />
		<echo message="  Phase 3: Collect Performance Data" />
		<echo message="================================================================" />

		<parallel>
			<!-- ============================================================= -->
			<!-- PARALLEL: Start all 5 services                                -->
			<!-- ============================================================= -->

			<!-- P1 Service -->
			<java classname="${service.loader.class}" fork="true" 
			      dir="${p1.project.dir}" output="${p1.output.file}">
				<classpath refid="p1.classpath" />
				<arg value="${p1.project.dir}" />
				<arg value="-version" />
				<arg value="${rule.version}" />
			</java>

			<!-- P2 Service -->
			<java classname="${service.loader.class}" fork="true" 
			      dir="${p2.project.dir}" output="${p2.output.file}">
				<classpath refid="p2.classpath" />
				<arg value="${p2.project.dir}" />
				<arg value="-version" />
				<arg value="${rule.version}" />
			</java>

			<!-- P3 Service -->
			<java classname="${service.loader.class}" fork="true" 
			      dir="${p3.project.dir}" output="${p3.output.file}">
				<classpath refid="p3.classpath" />
				<arg value="${p3.project.dir}" />
				<arg value="-version" />
				<arg value="${rule.version}" />
			</java>

			<!-- P4 Service -->
			<java classname="${service.loader.class}" fork="true" 
			      dir="${p4.project.dir}" output="${p4.output.file}">
				<classpath refid="p4.classpath" />
				<arg value="${p4.project.dir}" />
				<arg value="-version" />
				<arg value="${rule.version}" />
			</java>

			<!-- Monitor Service -->
			<java classname="${service.loader.class}" fork="true" 
			      dir="${monitor.project.dir}" output="${monitor.output.file}">
				<classpath refid="monitor.classpath" />
				<arg value="${monitor.project.dir}" />
				<arg value="-version" />
				<arg value="${rule.version}" />
			</java>

			<!-- ============================================================= -->
			<!-- SEQUENTIAL: Deploy and execute each phase                      -->
			<!-- ============================================================= -->
			<sequential>
				<echo message="Waiting ${service.startup.seconds}s for services to start..." />
				<sleep seconds="${service.startup.seconds}" />

				<!-- ======================================================= -->
				<!-- PHASE 1: Database Initialization                        -->
				<!-- ======================================================= -->
				<echo message="" />
				<echo message="===============================================" />
				<echo message="    PHASE 1: DATABASE INITIALIZATION           " />
				<echo message="===============================================" />
				
				<!-- Deploy Initialization rules (tokens=0) - deploys to ALL services -->
				<echo message="Deploying Initialization rules..." />
				<java classname="${init.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P1_InitializationService" />
					<arg value="-operation" /><arg value="purgeAndInitialize" />
					<arg value="-version" /><arg value="${rule.version}" />
					<arg value="-process" /><arg value="${init.process.name}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.init.p1}" />
					<arg value="-tokens" /><arg value="0" />
				</java>

				<!-- Fire initialization tokens (all in parallel - separate JVMs) -->
				<echo message="Firing initializations (P1, P2, P3, P4, Monitor)..." />
				<java classname="${init.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P1_InitializationService" />
					<arg value="-operation" /><arg value="${db.init.operation}" />
					<arg value="-version" /><arg value="${rule.version}" />
					<arg value="-process" /><arg value="${init.process.name}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.init.p1}" />
					<arg value="-tokens" /><arg value="1" />
					<arg value="-skipDeploy" />
				</java>
				<java classname="${init.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P2_InitializationService" />
					<arg value="-operation" /><arg value="${db.init.operation}" />
					<arg value="-version" /><arg value="${rule.version}" />
					<arg value="-process" /><arg value="${init.process.name}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.init.p2}" />
					<arg value="-tokens" /><arg value="1" />
					<arg value="-skipDeploy" />
				</java>
				<java classname="${init.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P3_InitializationService" />
					<arg value="-operation" /><arg value="${db.init.operation}" />
					<arg value="-version" /><arg value="${rule.version}" />
					<arg value="-process" /><arg value="${init.process.name}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.init.p3}" />
					<arg value="-tokens" /><arg value="1" />
					<arg value="-skipDeploy" />
				</java>
				<java classname="${init.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P4_InitializationService" />
					<arg value="-operation" /><arg value="${db.init.operation}" />
					<arg value="-version" /><arg value="${rule.version}" />
					<arg value="-process" /><arg value="${init.process.name}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.init.p4}" />
					<arg value="-tokens" /><arg value="1" />
					<arg value="-skipDeploy" />
				</java>
				<java classname="${init.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="Monitor_InitializationService" />
					<arg value="-operation" /><arg value="${db.init.operation}" />
					<arg value="-version" /><arg value="${rule.version}" />
					<arg value="-process" /><arg value="${init.process.name}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.init.monitor}" />
					<arg value="-tokens" /><arg value="1" />
					<arg value="-skipDeploy" />
				</java>
				<echo message="=== Phase 1 Complete ===" />
				<sleep seconds="${phase.delay.seconds}" />

				<!-- ======================================================= -->
				<!-- PHASE 2: Fork/Join Workflow Execution                   -->
				<!-- ======================================================= -->
				<echo message="" />
				<echo message="===============================================" />
				<echo message="    PHASE 2: FORK/JOIN WORKFLOW EXECUTION      " />
				<echo message="===============================================" />
				<echo message="Tokens: ${token.count}, Target: ${target.place}" />
				<echo message="Flow: P1 -> XOR Fork -> (P2+P3) -> Join -> P4 -> Monitor" />

				<!-- Deploy Workflow rules (tokens=0) - deploys to ALL services -->
				<echo message="Deploying Workflow rules..." />
				<java classname="${token.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-version" /><arg value="${rule.version}" />
					<arg value="-process" /><arg value="${workflow.process.name}" />
					<arg value="-place" /><arg value="${target.place}" />
					<arg value="-tokens" /><arg value="0" />
					<arg value="-expire" /><arg value="${token.expire}" />
				</java>

				<!-- Execute Workflow (tokens=N, -skipdeploy) -->
				<echo message="Firing ${token.count} tokens..." />
				<java classname="${token.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-version" /><arg value="${rule.version}" />
					<arg value="-process" /><arg value="${workflow.process.name}" />
					<arg value="-place" /><arg value="${target.place}" />
					<arg value="-tokens" /><arg value="${token.count}" />
					<arg value="-expire" /><arg value="${token.expire}" />
					<arg value="-skipdeploy" />
				</java>
				<echo message="=== Phase 2 Complete ===" />
				<sleep seconds="${phase.delay.seconds}" />

				<!-- ======================================================= -->
				<!-- PHASE 3: Data Collection                                -->
				<!-- ======================================================= -->
				<echo message="" />
				<echo message="===============================================" />
				<echo message="    PHASE 3: DATA COLLECTION                   " />
				<echo message="===============================================" />

				<!-- Fire collectors sequentially with delays -->
				<echo message="Firing collectors (P1, P2, P3, P4)..." />
				
				<!-- P1 Collector (deploys rules for all) -->
				<java classname="${collector.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P1_CollectorService" />
					<arg value="-operation" /><arg value="${service.operation}" />
					<arg value="-version" /><arg value="${rule.version}" />
					<arg value="-process" /><arg value="${collector.process.name}" />
					<arg value="-queryVersion" /><arg value="${query.version}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.collect.p1}" />
				</java>
				<sleep seconds="${collector.delay.seconds}" />

				<!-- P2 Collector -->
				<java classname="${collector.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P2_CollectorService" />
					<arg value="-operation" /><arg value="${service.operation}" />
					<arg value="-version" /><arg value="${rule.version}" />
					<arg value="-process" /><arg value="${collector.process.name}" />
					<arg value="-queryVersion" /><arg value="${query.version}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.collect.p2}" />
					<arg value="-skipDeploy" />
				</java>
				<sleep seconds="${collector.delay.seconds}" />

				<!-- P3 Collector -->
				<java classname="${collector.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P3_CollectorService" />
					<arg value="-operation" /><arg value="${service.operation}" />
					<arg value="-version" /><arg value="${rule.version}" />
					<arg value="-process" /><arg value="${collector.process.name}" />
					<arg value="-queryVersion" /><arg value="${query.version}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.collect.p3}" />
					<arg value="-skipDeploy" />
				</java>
				<sleep seconds="${collector.delay.seconds}" />

				<!-- P4 Collector -->
				<java classname="${collector.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P4_CollectorService" />
					<arg value="-operation" /><arg value="${service.operation}" />
					<arg value="-version" /><arg value="${rule.version}" />
					<arg value="-process" /><arg value="${collector.process.name}" />
					<arg value="-queryVersion" /><arg value="${query.version}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.collect.p4}" />
					<arg value="-skipDeploy" />
				</java>
				<echo message="=== Phase 3 Complete ===" />

				<!-- ======================================================= -->
				<!-- COMPLETE                                                -->
				<!-- ======================================================= -->
				<echo message="" />
				<echo message="================================================================" />
				<echo message="              ALL PHASES COMPLETED SUCCESSFULLY                " />
				<echo message="================================================================" />
				<echo message="" />
				<echo message="Output files:" />
				<echo message="  P1:      ${p1.output.file}" />
				<echo message="  P2:      ${p2.output.file}" />
				<echo message="  P3:      ${p3.output.file}" />
				<echo message="  P4:      ${p4.output.file}" />
				<echo message="  Monitor: ${monitor.output.file}" />
				<echo message="" />
				<echo message="Services are still running. Press Ctrl+C to stop." />
			</sequential>
		</parallel>
	</target>

	<!-- ======================================================================= -->
	<!-- HELP TARGET                                                             -->
	<!-- ======================================================================= -->

	<target name="help" description="Display usage information">
		<echo message="" />
		<echo message="================================================================" />
		<echo message="  P1_P2_P3_P4 Fork/Join Workflow - Consolidated Build          " />
		<echo message="================================================================" />
		<echo message="" />
		<echo message="WORKFLOW TOPOLOGY:" />
		<echo message="  P1 -> XOR Fork -> P2 ----+-> Join -> P4 -> Monitor" />
		<echo message="              |    P3 ----+" />
		<echo message="              +-> (false) -> Monitor (bypass)" />
		<echo message="" />
		<echo message="USAGE:" />
		<echo message="  ant                              Run complete workflow (default)" />
		<echo message="  ant run-complete-workflow        Run complete workflow" />
		<echo message="  ant help                         Show this help" />
		<echo message="" />
		<echo message="CONFIGURABLE PARAMETERS:" />
		<echo message="  -Drule.version=v001              Rule base version" />
		<echo message="  -Dtoken.count=10                 Number of tokens to generate" />
		<echo message="  -Dphase.delay.seconds=5          Delay between phases" />
		<echo message="  -Dcollector.delay.seconds=3      Delay between collectors" />
		<echo message="  -Ddb.init.operation=purgeAndInitialize  DB operation" />
		<echo message="" />
		<echo message="EXAMPLE:" />
		<echo message="  ant -Dtoken.count=50 -Dphase.delay.seconds=10" />
		<echo message="" />
		<echo message="WORKFLOW PHASES:" />
		<echo message="  1. Deploy + Initialize databases (P1, P2, P3, P4, Monitor)" />
		<echo message="  2. Deploy + Execute Fork/Join workflow" />
		<echo message="  3. Deploy + Collect performance data (P1, P2, P3, P4 -> Monitor)" />
		<echo message="" />
		<echo message="SERVICES:" />
		<echo message="  - P1_Place, P2_Place, P3_Place, P4_Place (workflow)" />
		<echo message="  - P1/P2/P3/P4_InitializationService (init)" />
		<echo message="  - P1/P2/P3/P4_CollectorService (collect)" />
		<echo message="  - MonitorService, Monitor_InitializationService" />
		<echo message="" />
		<echo message="NOTE: Services start once and remain running throughout all phases." />
		<echo message="      Press Ctrl+C to stop services when complete." />
		<echo message="" />
	</target>

</project>