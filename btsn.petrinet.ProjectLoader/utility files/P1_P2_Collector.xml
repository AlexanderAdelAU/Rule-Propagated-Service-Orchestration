<?xml version="1.0" encoding="UTF-8"?>
<project name="P1_P2_Collector" default="load-all-services" basedir=".">
	<description>
        Phase 3: P1, P2 and Monitor Services - Performance Data Collection
        Simple Loop Petri Net - Collector Workflow
    </description>

	<!-- =================================== -->
	<!-- PROPERTIES SECTION                 -->
	<!-- =================================== -->

	<!-- COLLECTOR PARAMETERS -->
	<property name="rule.version" value="v999" />
	<property name="process.name" value="petrinet/P1_P2_Collector" />
	<property name="service.operation" value="collectAllData" />
	<property name="collection.delay.seconds" value="3" />

	<!-- Version(s) to collect data from -->
	<property name="query.version" value="v001" />

	<!-- Sequence IDs for collectors -->
	<property name="sequence.id.p1" value="999010000" />
	<property name="sequence.id.p2" value="999020000" />
	<property name="sequence.id.monitor" value="999700000" />

	<!-- Timing -->
	<property name="port.release.seconds" value="5" />

	<!-- Base directories -->
	<property name="build.file.dir" location="." />
	<property name="petrinet.root.dir" location="../" />

	<!-- Common project directories -->
	<property name="common.project.dir" location="${petrinet.root.dir}/btsn.common" />
	<property name="lib.dir" location="${common.project.dir}/lib" />
	<property name="class.dir" location="${common.project.dir}/bin" />

	<!-- Output directory (current directory) -->
	<property name="output.dir" location="${build.file.dir}" />

	<!-- P1 Service -->
	<property name="p1.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p1" />
	<property name="p1.bin.dir" location="${p1.project.dir}/bin" />
	<property name="p1.output.file" location="${output.dir}/P1_CollectorService.out.txt" />

	<!-- P2 Service -->
	<property name="p2.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p2" />
	<property name="p2.bin.dir" location="${p2.project.dir}/bin" />
	<property name="p2.output.file" location="${output.dir}/P2_CollectorService.out.txt" />

	<!-- Monitor Service -->
	<property name="monitor.project.dir" location="${petrinet.root.dir}/btsn.common.Monitor" />
	<property name="monitor.bin.dir" location="${monitor.project.dir}/bin" />
	<property name="monitor.output.file" location="${output.dir}/MonitorService.out.txt" />

	<!-- Event Generator -->
	<property name="generator.project.dir" location="${petrinet.root.dir}/btsn.common.eventgenerators" />
	<property name="generator.bin.dir" location="${generator.project.dir}/bin" />

	<!-- Java Classes -->
	<property name="service.loader.class" value="org.btsn.handlers.ServiceLoader" />
	<property name="collector.generator.class" value="org.btsn.common.eventgenerators.Common_Collector_EventGenerator" />

	<!-- =================================== -->
	<!-- CLASSPATH SECTION                  -->
	<!-- =================================== -->

	<path id="common.classpath">
		<fileset dir="${lib.dir}" erroronmissingdir="false">
			<include name="*.jar" />
		</fileset>
		<pathelement location="${class.dir}" />
	</path>

	<path id="p1.classpath">
		<path refid="common.classpath" />
		<pathelement location="${p1.bin.dir}" />
	</path>

	<path id="p2.classpath">
		<path refid="common.classpath" />
		<pathelement location="${p2.bin.dir}" />
	</path>

	<path id="monitor.classpath">
		<path refid="common.classpath" />
		<pathelement location="${monitor.bin.dir}" />
	</path>

	<path id="generator.classpath">
		<path refid="common.classpath" />
		<pathelement location="${generator.bin.dir}" />
	</path>

	<!-- =================================== -->
	<!-- UTILITY TARGETS                    -->
	<!-- =================================== -->

	<target name="kill-java-processes" description="Kill any lingering Java processes">
		<echo message="Killing any lingering Java processes..." />
		<exec executable="cmd" osfamily="windows" failonerror="false">
			<arg value="/c"/>
			<arg value="taskkill /F /IM java.exe /T 2>nul"/>
		</exec>
		<exec executable="bash" osfamily="unix" failonerror="false">
			<arg value="-c"/>
			<arg value="pkill -9 java 2>/dev/null || true"/>
		</exec>
		<echo message="Waiting ${port.release.seconds}s for ports to be released..." />
		<sleep seconds="${port.release.seconds}"/>
		<echo message="Process cleanup complete" />
	</target>

	<target name="clean-output" description="Clean previous output files">
		<delete file="${p1.output.file}" quiet="true" />
		<delete file="${p2.output.file}" quiet="true" />
		<delete file="${monitor.output.file}" quiet="true" />
		<echo message="Previous output files cleaned" />
	</target>

	<!-- =================================== -->
	<!-- RULE BASE BUILD TARGET             -->
	<!-- =================================== -->

	<target name="rebuild-service-ruleml" description="Rebuild master Service.ruleml from all service definitions">
		<echo message="=== Building Master Service.ruleml ===" />
		<java classname="org.btsn.utils.BuildMasterServiceRuleBase" 
		      classpathref="generator.classpath"
		      dir="${common.project.dir}"
		      fork="true"
		      failonerror="true">
			<arg value="${rule.version}" />
			<arg value="ALL" />
		</java>
		<echo message="Master Service.ruleml built successfully" />
	</target>

	<!-- =================================== -->
	<!-- SERVICE LOADING TARGETS            -->
	<!-- =================================== -->

	<target name="load-p1-service" description="Load P1_CollectorService">
		<echo message="Starting P1_CollectorService..." />
		<java classname="${service.loader.class}" 
		      fork="true" 
		      dir="${p1.project.dir}"
		      output="${p1.output.file}">
			<classpath refid="p1.classpath" />
			<arg value="${p1.project.dir}" />
			<arg value="-version" />
			<arg value="${rule.version}" />
			<arg value="-service" />
			<arg value="P1_CollectorService" />
		</java>
	</target>

	<target name="load-p2-service" description="Load P2_CollectorService">
		<echo message="Starting P2_CollectorService..." />
		<java classname="${service.loader.class}" 
		      fork="true" 
		      dir="${p2.project.dir}"
		      output="${p2.output.file}">
			<classpath refid="p2.classpath" />
			<arg value="${p2.project.dir}" />
			<arg value="-version" />
			<arg value="${rule.version}" />
			<arg value="-service" />
			<arg value="P2_CollectorService" />
		</java>
	</target>

	<target name="load-monitor-service" description="Load Monitor service">
		<echo message="Starting Monitor service..." />
		<java classname="${service.loader.class}" 
		      fork="true" 
		      dir="${monitor.project.dir}"
		      output="${monitor.output.file}">
			<classpath refid="monitor.classpath" />
			<arg value="${monitor.project.dir}" />
			<arg value="-version" />
			<arg value="${rule.version}" />
			<arg value="-service" />
			<arg value="MonitorService" />
		</java>
	</target>

	<!-- =================================== -->
	<!-- PERFORMANCE COLLECTOR TRIGGER      -->
	<!-- =================================== -->

	<target name="performance-collector-trigger" description="Trigger Performance Data Collection for P1-P2">
		<echo message="=== Initializing Performance Collector ===" />
		<echo message="  Rule Version: ${rule.version}" />
		<echo message="  Process: ${process.name}" />
		<echo message="  Query Versions: ${query.version}" />
		<echo message="  Delay between collectors: ${collection.delay.seconds} seconds" />

		<!-- P1 Collection (with deployment) -->
		<echo message="=== Collecting from P1_CollectorService (deploying rules) ===" />
		<java classname="${collector.generator.class}" 
		      fork="true" 
		      dir="${generator.project.dir}"
		      failonerror="true">
			<classpath refid="generator.classpath" />
			<arg value="-service" /><arg value="P1_CollectorService" />
			<arg value="-operation" /><arg value="${service.operation}" />
			<arg value="-version" /><arg value="${rule.version}" />
			<arg value="-process" /><arg value="${process.name}" />
			<arg value="-queryVersion" /><arg value="${query.version}" />
			<arg value="-sequenceId" /><arg value="${sequence.id.p1}" />
		</java>
		<echo message="P1 Collection finished." />
		<sleep seconds="${collection.delay.seconds}" />

		<!-- P2 Collection (skip deployment) -->
		<echo message="=== Collecting from P2_CollectorService (skipping deploy) ===" />
		<java classname="${collector.generator.class}" 
		      fork="true" 
		      dir="${generator.project.dir}"
		      failonerror="true">
			<classpath refid="generator.classpath" />
			<arg value="-service" /><arg value="P2_CollectorService" />
			<arg value="-operation" /><arg value="${service.operation}" />
			<arg value="-version" /><arg value="${rule.version}" />
			<arg value="-process" /><arg value="${process.name}" />
			<arg value="-queryVersion" /><arg value="${query.version}" />
			<arg value="-sequenceId" /><arg value="${sequence.id.p2}" />
			<arg value="-skipDeploy" />
		</java>
		<echo message="P2 Collection finished." />
		<sleep seconds="${collection.delay.seconds}" />

		<echo message="=== Performance Collector finished for all services ===" />
	</target>

	<!-- =================================== -->
	<!-- MAIN TARGET                         -->
	<!-- =================================== -->

	<target name="load-all-services" 
	        depends="kill-java-processes,clean-output,rebuild-service-ruleml" 
	        description="Load collector services and trigger collection (DEFAULT)">
		<echo message="=== COLLECTION: LOADING COLLECTOR SERVICES ===" />
		<echo message="Rule version: ${rule.version}" />
		<echo message="Process Name: ${process.name}" />
		<echo message="Query Version: ${query.version}" />
		<echo message="" />

		<!-- Start collector services in parallel -->
		<parallel timeout="300000">
			<antcall target="load-p1-service" />
			<antcall target="load-p2-service" />
			<antcall target="load-monitor-service" />

			<sequential>
				<echo message="Waiting for collector services to initialize..." />
				<sleep seconds="3" />
				<antcall target="performance-collector-trigger" />
				<echo message="" />
				<echo message="Collection complete. Killing services..." />
				<sleep seconds="2" />
				<antcall target="kill-java-processes" />
			</sequential>
		</parallel>

		<echo message="" />
		<echo message="=== COLLECTION COMPLETE ===" />
	</target>

	<!-- =================================== -->
	<!-- HELP TARGET                        -->
	<!-- =================================== -->

	<target name="help" description="Display available targets">
		<echo message="=== PHASE 3: P1-P2 COLLECTOR ===" />
		<echo message="" />
		<echo message="MAIN TARGET:" />
		<echo message="  load-all-services           - Kill processes, load services, collect data (DEFAULT)" />
		<echo message="" />
		<echo message="INDIVIDUAL TARGETS:" />
		<echo message="  kill-java-processes         - Kill any lingering Java processes" />
		<echo message="  performance-collector-trigger - Trigger collection only (assumes services running)" />
		<echo message="" />
		<echo message="PARAMETERS:" />
		<echo message="  rule.version             = ${rule.version}" />
		<echo message="  process.name             = ${process.name}" />
		<echo message="  query.version            = ${query.version}" />
		<echo message="  collection.delay.seconds = ${collection.delay.seconds}" />
		<echo message="" />
		<echo message="USAGE:" />
		<echo message="  ant -f P1_P2_Collector.xml" />
		<echo message="  ant -f P1_P2_Collector.xml -Dquery.version=v001,v002" />
		<echo message="" />
	</target>

</project>