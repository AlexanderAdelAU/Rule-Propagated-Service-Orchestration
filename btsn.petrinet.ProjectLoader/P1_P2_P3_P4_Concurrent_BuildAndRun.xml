<?xml version="1.0" encoding="UTF-8"?>

<project name="P1_P2_P3_P4_Concurrent_BuildAndRun" default="run-complete-workflow" basedir="."
	    xmlns:if="ant:if" xmlns:unless="ant:unless">
	<description>
		P1_P2_P3_P4 Concurrent Petri Net - Multi-Workflow Execution
		
		This build file demonstrates concurrent execution of TWO separate workflows:
		- workflow1: P1_P2_P3_P4_Fork_Workflow (v001) - Fork/Join pattern through P1->P2,P3->P4
		- workflow2: P1_P2_Workflow (v002) - Simple sequential P1->P2
		
		Architecture:
		- Phase 1: Load services ONCE, Initialize databases
		- Phase 2: Deploy BOTH workflows sequentially -> Fire tokens from BOTH generators in PARALLEL
		- Phase 3: Deploy collector rules -> Collect data
		
		Each workflow has its own process definition JSON file and version for token isolation.
	</description>

	<!-- ======================================================================= -->
	<!-- DEPLOYMENT CONFIGURATION                                                -->
	<!-- ======================================================================= -->
	<!-- Service deployment modes:                                                -->
	<!--   local  = launch service process on THIS machine                       -->
	<!--   remote = service runs on ANOTHER machine (skip launch, still send     -->
	<!--            events to it for init/workflow/collection phases)             -->
	<!--                                                                         -->
	<!-- Override from command line: ant -Dp1.mode=remote -Dp2.mode=remote        -->
	<!-- ======================================================================= -->

	<property name="p1.mode"      value="local" />
	<property name="p2.mode"      value="local" />
	<property name="p3.mode"      value="local" />
	<property name="p4.mode"      value="local" />
	<property name="monitor.mode" value="local" />

	<!-- ======================================================================= -->
	<!-- PROPERTIES                                                              -->
	<!-- ======================================================================= -->

	<!-- Process names for each phase -->
	<property name="init.process.name" value="petrinet/Initializers/P1_P2_P3_P4_Initialization" />
	<property name="workflow1.process.name" value="petrinet/Workflow/P1_P2_P3_P4_Fork_Join_Workflow" />
	<property name="workflow2.process.name" value="petrinet/Workflow/P1_P2_Workflow" />
	<property name="collector.process.name" value="petrinet/Collectors/P1_P2_P3_P4_Collector" />

	<!-- Phase 1: Initialization parameters (v999 = admin/non-instrumented) -->
	<property name="init.version" value="v999" />
	<property name="db.init.operation" value="purgeAndInitialize" />
	<property name="sequence.id.init.p1" value="999000000" />
	<property name="sequence.id.init.p2" value="999100000" />
	<property name="sequence.id.init.p3" value="999200000" />
	<property name="sequence.id.init.p4" value="999300000" />
	<property name="sequence.id.init.monitor" value="999400000" />

	<!-- ======================================================================= -->
	<!-- WORKFLOW 1: P1_P2_P3_P4_Fork_Workflow (v001) - Fork/Join Pattern        -->
	<!-- ======================================================================= -->
	<property name="workflow1.version" value="v001" />
	<property name="workflow1.generator.id" value="EVENT_GENERATOR" />
	<property name="workflow1.target.place" value="P1_Place" />
	<property name="workflow1.target.operation" value="processToken" />
	<property name="workflow1.token.count" value="10" />
	<property name="workflow1.token.expire" value="120000" />

	<!-- ======================================================================= -->
	<!-- WORKFLOW 2: P1_P2_Workflow (v002) - Simple Sequential                   -->
	<!-- ======================================================================= -->
	<property name="workflow2.version" value="v002" />
	<property name="workflow2.generator.id" value="P1_EVENTGENERATOR" />
	<property name="workflow2.target.place" value="P1_Place" />
	<property name="workflow2.target.operation" value="processToken" />
	<property name="workflow2.token.count" value="10" />
	<property name="workflow2.token.expire" value="120000" />

	<!-- Phase 3: Collector parameters -->
	<property name="collector.version" value="v999" />
	<property name="collector.operation" value="collectAllData" />
	<property name="collector.query.versions" value="v001,v002" />
	<property name="sequence.id.collect.p1" value="999010000" />
	<property name="sequence.id.collect.p2" value="999020000" />
	<property name="sequence.id.collect.p3" value="999030000" />
	<property name="sequence.id.collect.p4" value="999040000" />
	<property name="collector.delay.seconds" value="3" />

	<!-- Timing parameters -->
	<property name="service.startup.seconds" value="3" />
	<property name="phase.delay.seconds" value="5" />
	<property name="deploy.wait.seconds" value="3" />

	<!-- Base directories -->
	<property name="build.file.dir" location="." />
	<property name="petrinet.root.dir" location="../" />

	<!-- Common project -->
	<property name="common.project.dir" location="${petrinet.root.dir}/btsn.common" />
	<property name="lib.dir" location="${common.project.dir}/lib" />
	<property name="class.dir" location="${common.project.dir}/bin" />
	<property name="common.src.dir" location="${common.project.dir}/src" />

	<!-- Output directory -->
	<property name="output.dir" location="${build.file.dir}" />
	<property name="p1.output.file" location="${output.dir}/P1_Place.out.txt" />
	<property name="p2.output.file" location="${output.dir}/P2_Place.out.txt" />
	<property name="p3.output.file" location="${output.dir}/P3_Place.out.txt" />
	<property name="p4.output.file" location="${output.dir}/P4_Place.out.txt" />
	<property name="monitor.output.file" location="${output.dir}/MonitorService.out.txt" />

	<!-- P1-P4 Services -->
	<property name="p1.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p1" />
	<property name="p1.bin.dir" location="${p1.project.dir}/bin" />

	<property name="p2.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p2" />
	<property name="p2.bin.dir" location="${p2.project.dir}/bin" />

	<property name="p3.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p3" />
	<property name="p3.bin.dir" location="${p3.project.dir}/bin" />

	<property name="p4.project.dir" location="${petrinet.root.dir}/btsn.petrinet.places.p4" />
	<property name="p4.bin.dir" location="${p4.project.dir}/bin" />

	<!-- Monitor Service -->
	<property name="monitor.project.dir" location="${petrinet.root.dir}/btsn.common.Monitor" />
	<property name="monitor.bin.dir" location="${monitor.project.dir}/bin" />

	<!-- Event Generators -->
	<property name="generator.project.dir" location="${petrinet.root.dir}/btsn.common.eventgenerators" />
	<property name="generator.bin.dir" location="${generator.project.dir}/bin" />

	<!-- Java Classes -->
	<property name="service.loader.class" value="org.btsn.handlers.ServiceLoader" />
	<property name="init.event.generator.class" value="org.btsn.common.eventgenerators.DatabaseInitialization_EventGenerator" />
	<property name="token.generator.class" value="org.btsn.petrinet.eventgenerators.GenericPetriNetTokenGenerator" />
	<property name="collector.event.generator.class" value="org.btsn.common.eventgenerators.Common_Collector_EventGenerator" />

	<!-- ======================================================================= -->
	<!-- CLASSPATHS                                                              -->
	<!-- ======================================================================= -->

	<path id="common.classpath">
		<fileset dir="${lib.dir}" erroronmissingdir="false">
			<include name="*.jar" />
		</fileset>
		<pathelement location="${class.dir}" />
	</path>

	<path id="p1.classpath">
		<path refid="common.classpath" />
		<pathelement location="${p1.bin.dir}" />
	</path>

	<path id="p2.classpath">
		<path refid="common.classpath" />
		<pathelement location="${p2.bin.dir}" />
	</path>

	<path id="p3.classpath">
		<path refid="common.classpath" />
		<pathelement location="${p3.bin.dir}" />
	</path>

	<path id="p4.classpath">
		<path refid="common.classpath" />
		<pathelement location="${p4.bin.dir}" />
	</path>

	<path id="monitor.classpath">
		<path refid="common.classpath" />
		<pathelement location="${monitor.bin.dir}" />
	</path>

	<path id="generator.classpath">
		<path refid="common.classpath" />
		<pathelement location="${generator.bin.dir}" />
	</path>

	<!-- ======================================================================= -->
	<!-- DEPLOYMENT MODE RESOLUTION                                              -->
	<!-- ======================================================================= -->

	<target name="resolve-deployment-modes">
		<!-- Resolve boolean properties from mode settings -->
		<condition property="p1.is.local"><equals arg1="${p1.mode}" arg2="local" /></condition>
		<condition property="p2.is.local"><equals arg1="${p2.mode}" arg2="local" /></condition>
		<condition property="p3.is.local"><equals arg1="${p3.mode}" arg2="local" /></condition>
		<condition property="p4.is.local"><equals arg1="${p4.mode}" arg2="local" /></condition>
		<condition property="monitor.is.local"><equals arg1="${monitor.mode}" arg2="local" /></condition>

		<!-- Display deployment configuration -->
		<echo message="" />
		<echo message="  Deployment Configuration:" />
		<echo message="    P1:      ${p1.mode}" />
		<echo message="    P2:      ${p2.mode}" />
		<echo message="    P3:      ${p3.mode}" />
		<echo message="    P4:      ${p4.mode}" />
		<echo message="    Monitor: ${monitor.mode}" />
		<echo message="" />
	</target>

	<!-- ======================================================================= -->
	<!-- UTILITY TARGETS                                                         -->
	<!-- ======================================================================= -->

	<target name="create-output-directory">
		<mkdir dir="${output.dir}" />
	</target>

	<target name="clean-output" description="Clean previous output files">
		<delete file="${p1.output.file}" quiet="true" />
		<delete file="${p2.output.file}" quiet="true" />
		<delete file="${p3.output.file}" quiet="true" />
		<delete file="${p4.output.file}" quiet="true" />
		<delete file="${monitor.output.file}" quiet="true" />
		<echo message="Previous output files cleaned" />
	</target>

	<target name="generate-workflow-bindings" description="Generate canonical bindings for both workflows">
		<echo message="=== Generating Workflow 1 Bindings (${workflow1.process.name}) ===" />
		<java classname="org.btsn.rulecontroller.TopologyBindingGenerator" 
		      classpathref="generator.classpath"
		      dir="${common.project.dir}"
		      fork="true"
		      failonerror="true">
			<arg value="${workflow1.process.name}" />
			<arg value="${workflow1.version}" />
		</java>
		
		<echo message="=== Generating Workflow 2 Bindings (${workflow2.process.name}) ===" />
		<java classname="org.btsn.rulecontroller.TopologyBindingGenerator" 
		      classpathref="generator.classpath"
		      dir="${common.project.dir}"
		      fork="true"
		      failonerror="true">
			<arg value="${workflow2.process.name}" />
			<arg value="${workflow2.version}" />
		</java>
		<echo message="All workflow bindings generated successfully" />
	</target>

	<target name="rebuild-service-ruleml" depends="generate-workflow-bindings" 
	        description="Generate bindings and rebuild master Service.ruleml">
		<echo message="=== Building Master Service.ruleml (v001) ===" />
		<java classname="org.btsn.utils.BuildMasterServiceRuleBase" 
		      classpathref="generator.classpath"
		      dir="${common.project.dir}"
		      fork="true"
		      failonerror="true">
			<arg value="${workflow1.version}" />
			<arg value="ALL" />
		</java>
		
		<echo message="=== Building Master Service.ruleml (v002) ===" />
		<java classname="org.btsn.utils.BuildMasterServiceRuleBase" 
		      classpathref="generator.classpath"
		      dir="${common.project.dir}"
		      fork="true"
		      failonerror="true">
			<arg value="${workflow2.version}" />
			<arg value="ALL" />
		</java>
		<echo message="Master Service.ruleml files built successfully" />
	</target>

	<!-- ======================================================================= -->
	<!-- MAIN WORKFLOW TARGET                                                    -->
	<!-- ======================================================================= -->

	<target name="run-complete-workflow" depends="resolve-deployment-modes,create-output-directory,clean-output,rebuild-service-ruleml"
	        description="Run complete concurrent workflow with init, execution and collection">

		<echo message="================================================================" />
		<echo message="  P1_P2_P3_P4 CONCURRENT PETRI NET - MULTI-WORKFLOW EXECUTION  " />
		<echo message="================================================================" />
		<echo message="" />
		<echo message="  Workflows:" />
		<echo message="    1. ${workflow1.process.name} (${workflow1.version}): ${workflow1.token.count} tokens" />
		<echo message="    2. ${workflow2.process.name} (${workflow2.version}): ${workflow2.token.count} tokens" />
		<echo message="" />
		<echo message="  Token Isolation via versions: v001, v002" />
		<echo message="================================================================" />

		<parallel>
			<!-- ============================================================= -->
			<!-- PARALLEL: Start all 5 services (ONCE)                         -->
			<!-- ============================================================= -->

			<!-- P1 Service -->
			<echo message="  [p1] Skipping - running on remote host" unless:set="p1.is.local" />
			<java classname="${service.loader.class}" fork="true" if:set="p1.is.local"
			      dir="${p1.project.dir}" output="${p1.output.file}">
				<classpath refid="p1.classpath" />
				<arg value="${p1.project.dir}" />
				<arg value="-version" /><arg value="${workflow1.version}" />
			</java>

			<!-- P2 Service -->
			<echo message="  [p2] Skipping - running on remote host" unless:set="p2.is.local" />
			<java classname="${service.loader.class}" fork="true" if:set="p2.is.local"
			      dir="${p2.project.dir}" output="${p2.output.file}">
				<classpath refid="p2.classpath" />
				<arg value="${p2.project.dir}" />
				<arg value="-version" /><arg value="${workflow1.version}" />
			</java>

			<!-- P3 Service -->
			<echo message="  [p3] Skipping - running on remote host" unless:set="p3.is.local" />
			<java classname="${service.loader.class}" fork="true" if:set="p3.is.local"
			      dir="${p3.project.dir}" output="${p3.output.file}">
				<classpath refid="p3.classpath" />
				<arg value="${p3.project.dir}" />
				<arg value="-version" /><arg value="${workflow1.version}" />
			</java>

			<!-- P4 Service -->
			<echo message="  [p4] Skipping - running on remote host" unless:set="p4.is.local" />
			<java classname="${service.loader.class}" fork="true" if:set="p4.is.local"
			      dir="${p4.project.dir}" output="${p4.output.file}">
				<classpath refid="p4.classpath" />
				<arg value="${p4.project.dir}" />
				<arg value="-version" /><arg value="${workflow1.version}" />
			</java>

			<!-- Monitor Service -->
			<echo message="  [monitor] Skipping - running on remote host" unless:set="monitor.is.local" />
			<java classname="${service.loader.class}" fork="true" if:set="monitor.is.local"
			      dir="${monitor.project.dir}" output="${monitor.output.file}">
				<classpath refid="monitor.classpath" />
				<arg value="${monitor.project.dir}" />
				<arg value="-version" /><arg value="${workflow1.version}" />
			</java>

			<!-- ============================================================= -->
			<!-- SEQUENTIAL: Execute phases in order                           -->
			<!-- ============================================================= -->
			<sequential>
				<echo message="Waiting ${service.startup.seconds}s for services to start..." />
				<sleep seconds="${service.startup.seconds}" />

				<!-- ======================================================= -->
				<!-- PHASE 1: Database Initialization                        -->
				<!-- ======================================================= -->
				<echo message="" />
				<echo message="===============================================" />
				<echo message="    PHASE 1: DATABASE INITIALIZATION           " />
				<echo message="===============================================" />
				
				<!-- Deploy Initialization rules -->
				<echo message="Deploying Initialization rules..." />
				<java classname="${init.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P1_InitializationService" />
					<arg value="-operation" /><arg value="${db.init.operation}" />
					<arg value="-version" /><arg value="${init.version}" />
					<arg value="-process" /><arg value="${init.process.name}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.init.p1}" />
					<arg value="-tokens" /><arg value="0" />
				</java>

				<!-- Fire initialization tokens in PARALLEL -->
				<echo message="Firing initialization tokens in PARALLEL..." />
				<parallel>
					<java classname="${init.event.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-service" /><arg value="P1_InitializationService" />
						<arg value="-operation" /><arg value="${db.init.operation}" />
						<arg value="-version" /><arg value="${init.version}" />
						<arg value="-process" /><arg value="${init.process.name}" />
						<arg value="-sequenceId" /><arg value="${sequence.id.init.p1}" />
						<arg value="-tokens" /><arg value="1" />
						<arg value="-skipDeploy" />
					</java>
					<java classname="${init.event.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-service" /><arg value="P2_InitializationService" />
						<arg value="-operation" /><arg value="${db.init.operation}" />
						<arg value="-version" /><arg value="${init.version}" />
						<arg value="-process" /><arg value="${init.process.name}" />
						<arg value="-sequenceId" /><arg value="${sequence.id.init.p2}" />
						<arg value="-tokens" /><arg value="1" />
						<arg value="-skipDeploy" />
					</java>
					<java classname="${init.event.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-service" /><arg value="P3_InitializationService" />
						<arg value="-operation" /><arg value="${db.init.operation}" />
						<arg value="-version" /><arg value="${init.version}" />
						<arg value="-process" /><arg value="${init.process.name}" />
						<arg value="-sequenceId" /><arg value="${sequence.id.init.p3}" />
						<arg value="-tokens" /><arg value="1" />
						<arg value="-skipDeploy" />
					</java>
					<java classname="${init.event.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-service" /><arg value="P4_InitializationService" />
						<arg value="-operation" /><arg value="${db.init.operation}" />
						<arg value="-version" /><arg value="${init.version}" />
						<arg value="-process" /><arg value="${init.process.name}" />
						<arg value="-sequenceId" /><arg value="${sequence.id.init.p4}" />
						<arg value="-tokens" /><arg value="1" />
						<arg value="-skipDeploy" />
					</java>
					<java classname="${init.event.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-service" /><arg value="Monitor_InitializationService" />
						<arg value="-operation" /><arg value="${db.init.operation}" />
						<arg value="-version" /><arg value="${init.version}" />
						<arg value="-process" /><arg value="${init.process.name}" />
						<arg value="-sequenceId" /><arg value="${sequence.id.init.monitor}" />
						<arg value="-tokens" /><arg value="1" />
						<arg value="-skipDeploy" />
					</java>
				</parallel>

				<echo message="=== Phase 1 Complete ===" />
				<sleep seconds="${phase.delay.seconds}" />

				<!-- ======================================================= -->
				<!-- PHASE 2: Concurrent Workflow Execution                  -->
				<!-- Deploy BOTH workflows -> Fire from BOTH generators in PARALLEL -->
				<!-- ======================================================= -->
				<echo message="" />
				<echo message="===============================================" />
				<echo message="    PHASE 2: CONCURRENT WORKFLOW EXECUTION     " />
				<echo message="===============================================" />
				<echo message="" />
				<echo message="Workflows:" />
				<echo message="  ${workflow1.process.name} (${workflow1.version}): EVENT_GENERATOR -> P1->P2,P3->P4" />
				<echo message="  ${workflow2.process.name} (${workflow2.version}): P1_EVENTGENERATOR -> P1->P2" />
				<echo message="" />

				<!-- Deploy Workflow 1: P1_P2_P3_P4_Fork_Workflow (v001) -->
				<echo message="[DEPLOY 1/2] Deploying ${workflow1.process.name} for ${workflow1.version} (EVENT_GENERATOR)..." />
				<java classname="${token.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-version" /><arg value="${workflow1.version}" />
					<arg value="-process" /><arg value="${workflow1.process.name}" />
					<arg value="-place" /><arg value="${workflow1.target.place}" />
					<arg value="-operation" /><arg value="${workflow1.target.operation}" />
					<arg value="-tokens" /><arg value="0" />
					<arg value="-expire" /><arg value="${workflow1.token.expire}" />
					<arg value="-generator" /><arg value="${workflow1.generator.id}" />
				</java>

				<!-- Deploy Workflow 2: P1_P2_Workflow (v002) -->
				<echo message="[DEPLOY 2/2] Deploying ${workflow2.process.name} for ${workflow2.version} (P1_EVENTGENERATOR)..." />
				<java classname="${token.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-version" /><arg value="${workflow2.version}" />
					<arg value="-process" /><arg value="${workflow2.process.name}" />
					<arg value="-place" /><arg value="${workflow2.target.place}" />
					<arg value="-operation" /><arg value="${workflow2.target.operation}" />
					<arg value="-tokens" /><arg value="0" />
					<arg value="-expire" /><arg value="${workflow2.token.expire}" />
					<arg value="-generator" /><arg value="${workflow2.generator.id}" />
				</java>

				<echo message="Waiting ${deploy.wait.seconds}s for commitment..." />
				<sleep seconds="${deploy.wait.seconds}" />

				<!-- Fire tokens from BOTH generators in PARALLEL -->
				<echo message="" />
				<echo message="[FIRE] Firing tokens from both generators in PARALLEL..." />
				<parallel>
					<!-- EVENT_GENERATOR: Fork/Join pattern through P1->P2,P3->P4 -->
					<java classname="${token.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-version" /><arg value="${workflow1.version}" />
						<arg value="-process" /><arg value="${workflow1.process.name}" />
						<arg value="-place" /><arg value="${workflow1.target.place}" />
						<arg value="-operation" /><arg value="${workflow1.target.operation}" />
						<arg value="-tokens" /><arg value="${workflow1.token.count}" />
						<arg value="-expire" /><arg value="${workflow1.token.expire}" />
						<arg value="-generator" /><arg value="${workflow1.generator.id}" />
						<arg value="-skipDeploy" />
					</java>

					<!-- P1_EVENTGENERATOR: Sequential P1->P2 -->
					<java classname="${token.generator.class}" 
					      fork="true" dir="${generator.project.dir}" failonerror="true">
						<classpath refid="generator.classpath" />
						<arg value="-version" /><arg value="${workflow2.version}" />
						<arg value="-process" /><arg value="${workflow2.process.name}" />
						<arg value="-place" /><arg value="${workflow2.target.place}" />
						<arg value="-operation" /><arg value="${workflow2.target.operation}" />
						<arg value="-tokens" /><arg value="${workflow2.token.count}" />
						<arg value="-expire" /><arg value="${workflow2.token.expire}" />
						<arg value="-generator" /><arg value="${workflow2.generator.id}" />
						<arg value="-skipDeploy" />
					</java>
				</parallel>

				<echo message="=== Phase 2 Complete ===" />
				<sleep seconds="${phase.delay.seconds}" />

				<!-- ======================================================= -->
				<!-- PHASE 3: Data Collection                                -->
				<!-- ======================================================= -->
				<echo message="" />
				<echo message="===============================================" />
				<echo message="    PHASE 3: DATA COLLECTION                   " />
				<echo message="===============================================" />

				<!-- Deploy Collector rules (first collector) -->
				<echo message="Deploying Collector rules..." />
				<java classname="${collector.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P1_CollectorService" />
					<arg value="-operation" /><arg value="${collector.operation}" />
					<arg value="-version" /><arg value="${collector.version}" />
					<arg value="-process" /><arg value="${collector.process.name}" />
					<arg value="-queryVersion" /><arg value="${collector.query.versions}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.collect.p1}" />
				</java>
				<sleep seconds="${collector.delay.seconds}" />

				<!-- Fire collectors sequentially with -skipDeploy -->
				<echo message="Collecting data from all services..." />

				<!-- P2 Collector -->
				<java classname="${collector.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P2_CollectorService" />
					<arg value="-operation" /><arg value="${collector.operation}" />
					<arg value="-version" /><arg value="${collector.version}" />
					<arg value="-process" /><arg value="${collector.process.name}" />
					<arg value="-queryVersion" /><arg value="${collector.query.versions}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.collect.p2}" />
					<arg value="-skipDeploy" />
				</java>
				<sleep seconds="${collector.delay.seconds}" />

				<!-- P3 Collector -->
				<java classname="${collector.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P3_CollectorService" />
					<arg value="-operation" /><arg value="${collector.operation}" />
					<arg value="-version" /><arg value="${collector.version}" />
					<arg value="-process" /><arg value="${collector.process.name}" />
					<arg value="-queryVersion" /><arg value="${collector.query.versions}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.collect.p3}" />
					<arg value="-skipDeploy" />
				</java>
				<sleep seconds="${collector.delay.seconds}" />

				<!-- P4 Collector -->
				<java classname="${collector.event.generator.class}" 
				      fork="true" dir="${generator.project.dir}" failonerror="true">
					<classpath refid="generator.classpath" />
					<arg value="-service" /><arg value="P4_CollectorService" />
					<arg value="-operation" /><arg value="${collector.operation}" />
					<arg value="-version" /><arg value="${collector.version}" />
					<arg value="-process" /><arg value="${collector.process.name}" />
					<arg value="-queryVersion" /><arg value="${collector.query.versions}" />
					<arg value="-sequenceId" /><arg value="${sequence.id.collect.p4}" />
					<arg value="-skipDeploy" />
				</java>

				<echo message="=== Phase 3 Complete ===" />

				<echo message="" />
				<echo message="================================================================" />
				<echo message="  MULTI-WORKFLOW EXECUTION COMPLETED SUCCESSFULLY              " />
				<echo message="================================================================" />
				<echo message="" />
				<echo message="Workflows Executed:" />
				<echo message="  1. ${workflow1.process.name} (${workflow1.version}): ${workflow1.token.count} tokens" />
				<echo message="  2. ${workflow2.process.name} (${workflow2.version}): ${workflow2.token.count} tokens" />
				<echo message="" />
				<echo message="Output files:" />
				<echo message="  P1: ${p1.output.file}" />
				<echo message="  P2: ${p2.output.file}" />
				<echo message="  P3: ${p3.output.file}" />
				<echo message="  P4: ${p4.output.file}" />
				<echo message="  Monitor: ${monitor.output.file}" />
				<echo message="" />
				<echo message="Services are still running. Press Ctrl+C to stop." />
			</sequential>
		</parallel>
	</target>

	<!-- ======================================================================= -->
	<!-- HELP TARGET                                                             -->
	<!-- ======================================================================= -->

	<target name="help" description="Display usage information">
		<echo message="" />
		<echo message="================================================================" />
		<echo message="  P1_P2_P3_P4 CONCURRENT - MULTI-WORKFLOW EXECUTION            " />
		<echo message="================================================================" />
		<echo message="" />
		<echo message="TWO CONCURRENT WORKFLOWS:" />
		<echo message="" />
		<echo message="  Workflow 1: ${workflow1.process.name} (${workflow1.version})" />
		<echo message="    EVENT_GENERATOR -> P1 -> [P2, P3] -> P4 -> Monitor" />
		<echo message="" />
		<echo message="  Workflow 2: ${workflow2.process.name} (${workflow2.version})" />
		<echo message="    P1_EVENTGENERATOR -> P1 -> P2 -> Monitor" />
		<echo message="" />
		<echo message="EXECUTION PATTERN:" />
		<echo message="  Phase 1: Load services ONCE, Initialize databases (parallel)" />
		<echo message="  Phase 2: Deploy BOTH workflows sequentially -> Fire BOTH generators in PARALLEL" />
		<echo message="  Phase 3: Collect data from all services" />
		<echo message="" />
		<echo message="USAGE:" />
		<echo message="  ant                              Run complete workflow (default)" />
		<echo message="  ant run-complete-workflow        Run complete workflow" />
		<echo message="  ant help                         Show this help" />
		<echo message="" />
		<echo message="DEPLOYMENT MODES (per service):" />
		<echo message="  -D&lt;service&gt;.mode=local           Launch service on this machine (default)" />
		<echo message="  -D&lt;service&gt;.mode=remote          Service runs on another machine (skip launch)" />
		<echo message="" />
		<echo message="  Services: p1, p2, p3, p4, monitor" />
		<echo message="" />
		<echo message="CONFIGURABLE PARAMETERS:" />
		<echo message="  -Dworkflow1.token.count=10       Tokens via EVENT_GENERATOR (workflow1)" />
		<echo message="  -Dworkflow2.token.count=10       Tokens via P1_EVENTGENERATOR (workflow2)" />
		<echo message="  -Dservice.startup.seconds=3      Wait for services to start" />
		<echo message="  -Dphase.delay.seconds=5          Delay between phases" />
		<echo message="" />
		<echo message="EXAMPLE:" />
		<echo message="  ant -Dworkflow1.token.count=20 -Dworkflow2.token.count=15" />
		<echo message="" />
	</target>

</project>